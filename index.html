<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>JiaJianAI Piano - Maestro Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lamejs@1.2.1/lame.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600&family=Noto+Serif+TC:wght@300;400;600&family=Inter:wght@300;400&display=swap');

        :root {
            --deep-space-bg: #0b0c15;
            --glass-surface: rgba(30, 30, 40, 0.65);
            --glass-border: rgba(255, 255, 255, 0.12);
            --gold-accent: #ffd700;
            --gold-glow: rgba(255, 215, 0, 0.3);
            --text-primary: #e2e8f0;
            --text-secondary: #94a3b8;
            --sat: env(safe-area-inset-top);
            --sab: env(safe-area-inset-bottom);
        }

        * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; touch-action: manipulation; }

        body {
            font-family: 'Noto Serif TC', 'Noto Serif SC', serif;
            background-color: var(--deep-space-bg);
            color: var(--text-primary);
            width: 100vw;
            margin: 0; padding: 0;
            user-select: none; -webkit-user-select: none;
            cursor: default;
            overflow-x: hidden;
            overflow-y: auto;
            min-height: 100dvh; 
        }
        
        @media (min-width: 1024px) {
            body { height: 100vh; overflow: hidden; }
        }

        /* --- 交互特效 --- */
        .click-glow {
            position: fixed; pointer-events: none; z-index: 9999;
            width: 50px; height: 50px; border-radius: 50%;
            background: radial-gradient(circle, rgba(253, 230, 138, 0.9) 0%, rgba(253, 230, 138, 0) 70%);
            transform: translate(-50%, -50%) scale(0.5);
            animation: ripple-fade 0.5s ease-out forwards;
            mix-blend-mode: screen; filter: blur(2px);
        }
        .click-particle {
            position: fixed; pointer-events: none; z-index: 9999;
            width: 2px; height: 2px; border-radius: 50%;
            background: #fff; box-shadow: 0 0 6px #fde68a;
            animation: particle-fly 0.6s ease-out forwards;
        }
        @keyframes ripple-fade { 
            0% { opacity: 1; transform: translate(-50%, -50%) scale(0.4); } 
            100% { opacity: 0; transform: translate(-50%, -50%) scale(2.0); } 
        }
        @keyframes particle-fly { 
            0% { opacity: 1; transform: translate(0, 0); } 
            100% { opacity: 0; transform: translate(var(--tx), var(--ty)); } 
        }

        .interactive-hover { transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94); }
        @media (hover: hover) {
            .interactive-hover:hover { transform: scale(1.02); text-shadow: 0 0 12px var(--gold-glow); filter: brightness(1.15); }
        }

        /* --- 背景 --- */
        #star-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; pointer-events: none; background: radial-gradient(circle at bottom, #1B2735 0%, #090A0F 100%); }

        /* --- 布局系统 --- */
        .main-layout {
            position: relative; z-index: 10;
            display: flex; flex-direction: column;
            width: 100%;
            padding: calc(16px + var(--sat)) 16px calc(40px + var(--sab)) 16px;
            gap: 20px;
            min-height: 100dvh;
        }

        @media (min-width: 1024px) {
            .main-layout { 
                display: grid; grid-template-columns: 1fr 400px; gap: 40px; padding: 40px; 
                height: 100vh; overflow: hidden; 
            }
            .glass-panel { overflow-y: auto !important; height: 100%; }
        }

        .glass-panel {
            background: var(--glass-surface);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-top: 1px solid rgba(255, 255, 255, 0.25);
            border-radius: 28px;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
            display: flex; flex-direction: column;
            position: relative;
            transition: all 0.3s ease;
            flex-shrink: 0;
        }

        @media (max-width: 1023px) {
            .glass-panel { 
                height: auto !important; min-height: 0 !important; flex: none !important; padding-bottom: 24px;
            }
            .turntable-box { max-width: 260px !important; margin-bottom: 20px !important; }
        }

        .player-wrapper { display: flex; flex-direction: column; align-items: center; width: 100%; padding: 20px 0; }
        .header-section { text-align: center; margin-bottom: 1.5rem; position: relative; z-index: 20; }
        .brand-title {
            font-family: 'Cinzel', serif; font-size: 2rem; font-weight: 400; letter-spacing: 0.1em;
            background: linear-gradient(to bottom, #fff 30%, #94a3b8 100%);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            text-shadow: 0 0 25px rgba(255,255,255,0.15); cursor: default;
        }
        .brand-subtitle { font-size: 0.7rem; letter-spacing: 0.3em; color: var(--gold-accent); opacity: 0.9; margin-top: 4px; font-family: 'Inter', sans-serif; text-transform: uppercase; }

        .turntable-box { position: relative; width: 100%; max-width: 320px; aspect-ratio: 1/1; margin: 0 auto 30px auto; display: flex; align-items: center; justify-content: center; }
        .record-border { 
            width: 100%; height: 100%; border-radius: 50%; 
            border: 1px solid rgba(255,255,255,0.08); background: rgba(0,0,0,0.4); 
            display: flex; align-items: center; justify-content: center; 
            box-shadow: 0 25px 60px rgba(0,0,0,0.5), inset 0 0 0 1px rgba(255,255,255,0.05);
        }
        .record-disc { 
            width: 95%; height: 95%; border-radius: 50%; background: #080808; 
            position: relative; overflow: hidden; 
            animation: rotate 8s linear infinite; animation-play-state: paused; 
            box-shadow: inset 0 0 0 2px #1a1a1a; 
        }
        .is-playing .record-disc { animation-play-state: running; }
        .vinyl-grooves { 
            position: absolute; inset: 0; border-radius: 50%; 
            background: repeating-radial-gradient(#080808 0, #080808 2px, #141414 3px, #141414 4px); 
            opacity: 0.8;
        }
        .vinyl-shimmer {
            position: absolute; inset: 0; border-radius: 50%;
            background: conic-gradient(from 180deg, transparent 0deg, rgba(255,255,255,0.08) 60deg, transparent 120deg);
            mix-blend-mode: overlay; pointer-events: none;
        }
        
        .album-label {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 42%; height: 42%; border-radius: 50%;
            background: radial-gradient(circle, #1e293b, #0f172a);
            border: 1px solid rgba(255,255,255,0.15); z-index: 10;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            cursor: pointer; transition: transform 0.2s; box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        .album-label:active { transform: translate(-50%, -50%) scale(0.96); }
        .play-icon { width: 28px; height: 28px; fill: var(--gold-accent); transition: 0.2s; filter: drop-shadow(0 0 5px var(--gold-glow)); }
        .pause-icon { width: 28px; height: 28px; fill: var(--gold-accent); display: none; transition: 0.2s; filter: drop-shadow(0 0 5px var(--gold-glow)); }
        .is-playing .play-icon { display: none; }
        .is-playing .pause-icon { display: block; }
        .tonearm { 
            position: absolute; top: -8%; right: -8%; width: 25%; height: 60%; 
            transform-origin: top center; transform: rotate(-35deg); 
            transition: transform 0.8s cubic-bezier(0.2, 0.8, 0.2, 1); 
            z-index: 20; pointer-events: none; filter: drop-shadow(5px 8px 8px rgba(0,0,0,0.6)); 
        }
        .is-playing .tonearm { transform: rotate(18deg); }

        /* Controls */
        .controls-wrapper { width: 100%; max-width: 400px; display: flex; flex-direction: column; gap: 20px; padding: 0 10px; }
        .mode-tabs { display: flex; justify-content: center; gap: 8px; margin-bottom: 5px; }
        .tab-btn { 
            padding: 8px 20px; border-radius: 99px; font-size: 13px; color: var(--text-secondary); 
            border: 1px solid transparent; background: rgba(255,255,255,0.02); transition: all 0.3s; cursor: pointer; 
        }
        .tab-btn.active { 
            color: var(--gold-accent); border-color: rgba(212, 175, 55, 0.3); 
            background: rgba(212, 175, 55, 0.05); font-weight: 600; box-shadow: 0 0 15px rgba(212, 175, 55, 0.05);
        }

        .mic-section { display: flex; flex-direction: column; align-items: center; gap: 14px; padding: 10px 0; }
        .mic-btn-wrap { position: relative; width: 88px; height: 88px; display: flex; align-items: center; justify-content: center; }
        .mic-btn { 
            width: 68px; height: 68px; border-radius: 50%; 
            background: linear-gradient(135deg, #ffd700, #b8860b); 
            box-shadow: 0 0 30px rgba(212, 175, 55, 0.2); 
            border: 2px solid rgba(255,255,255,0.9); 
            display: flex; align-items: center; justify-content: center; 
            cursor: pointer; transition: 0.2s; z-index: 5; 
        }
        .mic-btn:active { transform: scale(0.94); }
        .mic-btn.recording { background: #ef4444; border-color: #fecaca; box-shadow: 0 0 30px rgba(239, 68, 68, 0.4); animation: breathe 1.5s infinite; }
        .mic-hint { font-size: 12px; color: var(--text-secondary); text-align: center; letter-spacing: 1px; }

        /* 进度条 */
        .progress-bar-container { width: 100%; height: 4px; background: rgba(255,255,255,0.1); border-radius: 2px; margin-top: 10px; overflow: hidden; display: none; }
        .progress-bar { width: 0%; height: 100%; background: var(--gold-accent); transition: width 0.1s linear; box-shadow: 0 0 10px var(--gold-glow); }
        .processing .progress-bar-container { display: block; }

        .upload-row { width: 100%; display: flex; justify-content: center; margin-top: 8px; }
        .upload-icon-btn {
            width: 44px; height: 44px; border-radius: 50%;
            background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);
            color: var(--text-secondary); display: flex; align-items: center; justify-content: center;
            transition: 0.3s; cursor: pointer;
        }
        .upload-icon-btn:hover { border-color: var(--gold-accent); color: var(--gold-accent); background: rgba(212, 175, 55, 0.05); transform: scale(1.1); }

        .input-minimal { 
            width: 100%; padding: 14px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); 
            border-radius: 12px; color: #fff; text-align: center; outline: none; transition: 0.3s; font-family: 'Noto Serif SC';
            font-size: 16px; 
        }
        .input-minimal:focus { border-color: var(--gold-accent); }

        /* 历史记录 */
        .history-wrapper { display: flex; flex-direction: column; min-height: 300px; padding: 24px; }
        .history-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 12px; margin-bottom: 12px; }
        .history-list { flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
        .history-card { 
            background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.05); 
            padding: 14px; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; transition: 0.2s; 
        }
        .history-card.active { border-color: var(--gold-accent); background: rgba(212, 175, 55, 0.05); }
        .h-info { flex: 1; min-width: 0; padding-right: 12px; }
        .h-info h4 { font-size: 14px; color: #f1f5f9; margin-bottom: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .h-info p { font-size: 10px; color: #64748b; }
        .h-actions { display: flex; gap: 8px; align-items: center; flex-shrink: 0; }
        .icon-btn { 
            width: 32px; height: 32px; border-radius: 50%; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); 
            color: #94a3b8; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; 
        }
        .icon-btn:hover { background: var(--gold-accent); color: #000; border-color: var(--gold-accent); }
        .icon-btn.play-btn:hover { background: #fff; color: #000; }

        .toast { position: fixed; top: 80px; left: 50%; transform: translateX(-50%); background: rgba(255,255,255,0.95); color: #000; padding: 12px 24px; border-radius: 99px; font-size: 13px; font-weight: 600; letter-spacing: 0.5px; box-shadow: 0 10px 40px rgba(0,0,0,0.5); z-index: 10000; opacity: 0; pointer-events: none; transition: 0.3s; width: max-content; max-width: 90vw; text-align: center; }
        .toast.show { opacity: 1; top: 100px; }

        /* Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); backdrop-filter: blur(12px); z-index: 20000; display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: 0.3s; }
        .modal-overlay.show { opacity: 1; pointer-events: auto; }
        .modal-content { background: linear-gradient(145deg, #111827, #0f172a); border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 0 60px rgba(0,0,0,0.5); padding: 32px; border-radius: 24px; width: 85%; max-width: 340px; text-align: center; transform: scale(0.95); transition: 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .modal-overlay.show .modal-content { transform: scale(1); }
        .modal-title { font-family: 'Cinzel', serif; color: var(--text-primary); font-size: 1.5rem; margin-bottom: 24px; letter-spacing: 1px; }
        .modal-actions { display: flex; gap: 12px; justify-content: center; margin-top: 28px; }
        .modal-btn { padding: 12px 0; border-radius: 12px; font-size: 13px; font-weight: 600; cursor: pointer; transition: 0.2s; flex: 1; border: 1px solid transparent; }
        .btn-cancel { background: rgba(255,255,255,0.05); color: #94a3b8; border: 1px solid rgba(255,255,255,0.1); }
        .btn-confirm { background: var(--gold-accent); color: #000; box-shadow: 0 0 20px rgba(255, 215, 0, 0.2); }

        /* --- 录音中全屏提示弹窗 (含示波器) --- */
        #recording-hint-overlay {
            position: fixed; inset: 0; z-index: 5000;
            background: rgba(0,0,0,0.92); backdrop-filter: blur(20px);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            opacity: 0; pointer-events: none; transition: opacity 0.3s;
        }
        #recording-hint-overlay.show { opacity: 1; pointer-events: auto; }
        
        #mic-visualizer {
            width: 100%; max-width: 500px; height: 180px;
            margin: 20px 0;
            filter: drop-shadow(0 0 10px rgba(255, 215, 0, 0.2));
        }

        #timbre-hint {
            font-size: 14px; color: #fff; font-weight: 500; letter-spacing: 1px;
            margin-top: 10px; text-shadow: 0 0 10px rgba(255,255,255,0.5);
            transition: all 0.3s;
        }

        /* --- 生成中全屏提示 --- */
        #processing-overlay {
            position: fixed; inset: 0; z-index: 6000;
            background: #000; display: flex; flex-direction: column; align-items: center; justify-content: center;
            opacity: 0; pointer-events: none; transition: opacity 0.5s;
        }
        #processing-overlay.show { opacity: 1; pointer-events: auto; }

        @keyframes rotate { from {transform: rotate(0deg);} to {transform: rotate(360deg);} }
        @keyframes breathe { 0% {transform: scale(1);} 50% {transform: scale(1.05);} 100% {transform: scale(1);} }
        .hidden { display: none !important; }
    </style>
</head>
<body>

<canvas id="star-canvas"></canvas>
<div id="toast" class="toast">提示信息</div>

<!-- 1. 录音中全屏提示弹窗 (含实时示波器) -->
<div id="recording-hint-overlay">
    <div class="text-2xl font-serif text-yellow-100 mb-2 tracking-wider text-center px-6 leading-relaxed">
        慢慢哼唱<br><span class="text-yellow-400 font-bold text-3xl mt-2 block">感受当下</span>
    </div>
    
    <!-- Canvas 示波器 -->
    <div style="position: relative; width: 100%; display: flex; justify-content: center;">
        <canvas id="mic-visualizer" width="600" height="300"></canvas>
    </div>

    <!-- 实时提示文字 -->
    <div id="timbre-hint">聆听中...</div>
    
    <div class="text-red-400 text-sm tracking-[0.4em] animate-pulse font-bold mt-8">RECORDING</div>
</div>

<!-- 2. 审听弹窗 -->
<div id="preview-modal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-title">灵感捕获</div>
        <div class="flex flex-col items-center gap-6">
            <div class="w-20 h-20 rounded-full bg-white/5 flex items-center justify-center border border-white/10 cursor-pointer hover:bg-white/10 hover:border-yellow-500/50 transition-all group" onclick="playPreview()">
                <svg id="preview-play-icon" class="w-10 h-10 text-yellow-600 group-hover:text-yellow-400 transition-colors ml-1" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
            </div>
            <p class="text-sm text-gray-400">点击试听刚才的录音</p>
        </div>
        <div class="modal-actions">
            <button class="modal-btn btn-cancel" onclick="discardRecording()">删除重录</button>
            <button class="modal-btn btn-confirm" onclick="confirmRecording()">立即生成</button>
        </div>
    </div>
</div>

<!-- 3. 生成中全屏提示 -->
<div id="processing-overlay">
    <div class="text-3xl font-serif text-white mb-8 animate-pulse tracking-widest font-light">AI COMPOSING</div>
    <div class="w-64 h-1 bg-gray-800 rounded-full overflow-hidden">
        <div id="overlay-progress" class="h-full bg-gradient-to-r from-yellow-600 to-yellow-300 w-0 transition-all duration-100 ease-out shadow-[0_0_10px_rgba(253,230,138,0.5)]"></div>
    </div>
    <div id="processing-text" class="mt-4 text-gray-400 text-xs tracking-wider">正在分析音频特征...</div>
</div>

<div class="main-layout">
    <div class="glass-panel">
        <div class="player-wrapper">
            <div class="header-section interactive-hover">
                <div class="brand-title">JiaJianAI</div>
                <div class="brand-subtitle">Crystal Piano</div>
            </div>

            <div class="turntable-box">
                <div class="tonearm">
                    <svg width="100%" height="100%" viewBox="0 0 40 100">
                        <path d="M20,0 L20,70 L10,90" fill="none" stroke="#aaa" stroke-width="3" stroke-linecap="round"/>
                        <circle cx="20" cy="5" r="5" fill="#555"/>
                        <rect x="5" y="85" width="12" height="15" fill="#333" rx="1" transform="rotate(25 16 92)"/>
                    </svg>
                </div>
                <div class="record-border interactive-hover">
                    <div class="record-disc" id="record-disc">
                        <div class="vinyl-grooves"></div>
                        <div class="vinyl-shimmer"></div>
                        <!-- 中央播放控制 -->
                        <div class="album-label" id="play-pause-btn" onclick="togglePlayback()">
                            <div id="disk-title" class="font-serif text-[9px] text-gray-300 mb-1 tracking-widest max-w-[80px] truncate pointer-events-none">UNIVERSE</div>
                            <svg class="play-icon" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                            <svg class="pause-icon" viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
                            <div style="font-size: 8px; color: #666; margin-top: 4px; letter-spacing: 1px;" id="disk-status">READY</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="progress-container" class="progress-bar-container w-3/4 max-w-[280px] mx-auto mb-4">
                <div id="progress-bar" class="progress-bar"></div>
            </div>

            <div class="controls-wrapper">
                <div class="mode-tabs">
                    <div class="tab-btn active interactive-hover" onclick="setMode('hum')">哼唱</div>
                    <div class="tab-btn interactive-hover" onclick="setMode('search')">歌名生成</div>
                    <!-- 移除输简谱 Tab -->
                </div>

                <div id="panel-hum" class="mic-section">
                    <div class="mic-btn-wrap interactive-hover">
                        <div id="mic-btn" class="mic-btn">
                            <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path></svg>
                        </div>
                    </div>
                    <p class="mic-hint interactive-hover">长按录音 · 捕捉灵感</p>
                    <div class="upload-row">
                        <label class="upload-icon-btn interactive-hover" title="上传音频">
                            <input type="file" id="upload-input" accept="audio/*" class="hidden" onchange="handleFileUpload(this)">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                        </label>
                    </div>
                </div>

                <div id="panel-input" class="hidden w-full" style="padding: 10px 0;">
                    <input type="text" id="text-input" class="input-minimal interactive-hover" placeholder="输入歌名 (如: 七里香)..." onkeydown="if(event.key==='Enter') generateFromText()">
                    <button onclick="generateFromText()" class="upload-pill w-full mt-4 justify-center interactive-hover" style="background: rgba(212, 175, 55, 0.1); border-color: var(--gold-accent); color: var(--gold-accent);">生成乐曲</button>
                </div>

                <div class="flex gap-3 w-full mt-2">
                    <button id="btn-dl-mp3" disabled onclick="downloadMP3()" class="flex-1 py-3 bg-white/5 border border-white/10 hover:border-yellow-500/50 text-gray-400 hover:text-yellow-400 rounded-xl flex items-center justify-center gap-2 transition-all disabled:opacity-30 disabled:cursor-not-allowed group">
                        <svg class="w-4 h-4 group-hover:scale-110 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                        <span class="text-xs font-medium">下载 MP3</span>
                    </button>
                     <button id="btn-dl-pdf" disabled onclick="downloadSheetMusicPDF()" class="flex-1 py-3 bg-white/5 border border-white/10 hover:border-yellow-500/50 text-gray-400 hover:text-yellow-400 rounded-xl flex items-center justify-center gap-2 transition-all disabled:opacity-30 disabled:cursor-not-allowed group">
                        <svg class="w-4 h-4 group-hover:scale-110 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                        <span class="text-xs font-medium">下载乐谱</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="glass-panel history-wrapper">
        <div class="history-header interactive-hover">
            <span style="font-size: 14px; font-weight: 600; color: var(--gold-accent); letter-spacing: 1px;">暂存 · 记忆</span>
            <span style="font-size: 10px; color: #666;">SESSION LIBRARY</span>
        </div>
        <div id="history-list" class="history-list">
            <div style="text-align: center; color: #444; font-size: 12px; margin-top: 60px;">暂无记录</div>
        </div>
        <div style="margin-top: auto; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.1); font-size: 10px; color: #666; text-align: center;" class="interactive-hover">
            ⚠️ 离开页面后数据不保存，请及时下载
        </div>
    </div>
</div>

<script>
    // --- 1. Worker Script (DSP Core) ---
    const workerCode = `
        self.onmessage = function(e) {
            const { audioData, sampleRate } = e.data;
            const notes = analyzeAudio(audioData, sampleRate);
            self.postMessage({ notes });
        };

        const KEY_NAMES = ['C','Db','D','Eb','E','F','Gb','G','Ab','A','Bb','B'];

        function analyzeAudio(data, sr) {
            const notes = [];
            const dsLen = data.length;
            const dsData = data; 
            const dsRate = sr;

            let sum=0; 
            for(let k=0; k<Math.min(dsLen, dsRate*0.1); k++) {
                sum+=Math.abs(dsData[k]);
            }
            const noiseFloor = (sum/(dsRate*0.1)) * 1.5; 
            const gate = Math.max(0.015, noiseFloor);

            let i=0;
            const scanStep = Math.floor(dsRate * 0.015);
            let noteStart = -1;

            while(i < dsLen - scanStep) {
                let rms = 0; 
                for(let j=0; j<scanStep; j++) {
                    rms += dsData[i+j]*dsData[i+j];
                }
                rms = Math.sqrt(rms/scanStep);

                if(rms > gate) {
                    if(noteStart === -1) {
                        noteStart = i;
                    }
                } else {
                    if(noteStart !== -1) {
                        processSegment(dsData, noteStart, i, dsRate, notes, rms/gate);
                        noteStart = -1;
                    }
                }
                i += scanStep;
                if(i % (scanStep*20) === 0) {
                    self.postMessage({ progress: i/dsLen });
                }
            }
            if(noteStart !== -1) {
                processSegment(dsData, noteStart, dsLen, dsRate, notes, 1);
            }

            // Smart Transpose
            if(notes.length > 0) {
                const avgMidi = notes.reduce((s,n)=>s+n.midi,0)/notes.length;
                const target = 72; // C5
                const shift = Math.round(target - avgMidi);
                notes.forEach(n => {
                    let m = n.midi + shift;
                    n.note = KEY_NAMES[m%12] + (Math.floor(m/12)-1);
                    n.octave = Math.floor(m/12)-1;
                });
            }
            return notes;
        }

        function processSegment(data, start, end, sr, notesArr, dynamics) {
            const dur = (end-start)/sr;
            if(dur < 0.12) return; 
            
            const mid = Math.floor(start + (end-start)/2);
            const win = Math.min(end-start, Math.floor(sr*0.2));
            const slice = data.slice(mid - Math.floor(win/2), mid + Math.ceil(win/2));
            
            const freq = yinPitch(slice, sr);
            if(freq > 70 && freq < 1500) {
                const n = 12 * Math.log2(freq/440);
                const midi = Math.round(n) + 69;
                const name = KEY_NAMES[midi%12] + (Math.floor(midi/12)-1);
                const vel = Math.min(1.0, Math.max(0.4, dynamics * 0.7));
                notesArr.push({ note: name, duration: dur, midi: midi, velocity: vel });
            }
        }

        function yinPitch(buf, sr) {
            const tauMax = Math.floor(sr/70); 
            const yin = new Float32Array(tauMax);
            for(let tau=0; tau<tauMax; tau++) {
                for(let i=0; i<tauMax; i++) { const d = buf[i] - buf[i+tau]; yin[tau] += d*d; }
            }
            yin[0] = 1; let runningSum = 0;
            for(let tau=1; tau<tauMax; tau++) { runningSum += yin[tau]; yin[tau] *= tau / runningSum; }
            let tau = -1;
            for(let t=2; t<tauMax; t++) {
                if(yin[t] < 0.15) {
                    while(t+1 < tauMax && yin[t+1] < yin[t]) {
                        t++;
                    }
                    tau = t; break;
                }
            }
            if(tau === -1) return -1;
            if(tau > 0 && tau < tauMax-1) {
                const alpha = yin[tau-1], beta = yin[tau], gamma = yin[tau+1];
                tau += (alpha - gamma) / (2 * (alpha - 2*beta + gamma));
            }
            return sr/tau;
        }
    `;
    const blob = new Blob([workerCode], {type: 'application/javascript'});
    const workerUrl = URL.createObjectURL(blob);
    const audioWorker = new Worker(workerUrl);

    // --- Interaction ---
    document.addEventListener('click', (e) => { createRipple(e.clientX, e.clientY); createParticles(e.clientX, e.clientY); });
    function createRipple(x, y) { const r=document.createElement('div'); r.className='click-glow'; r.style.left=`${x}px`; r.style.top=`${y}px`; document.body.appendChild(r); setTimeout(()=>r.remove(),500); }
    function createParticles(x, y) { for(let i=0;i<5;i++){ const p=document.createElement('div'); p.className='click-particle'; p.style.left=`${x}px`; p.style.top=`${y}px`; const angle=Math.random()*Math.PI*2, dist=40+Math.random()*50; p.style.setProperty('--tx',`${Math.cos(angle)*dist}px`); p.style.setProperty('--ty',`${Math.sin(angle)*dist}px`); document.body.appendChild(p); setTimeout(()=>p.remove(),800); } }
    function showToast(msg) { const t=document.getElementById('toast'); t.innerText=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),3000); }

    // --- Starry Background ---
    const canvas=document.getElementById('star-canvas'), ctx=canvas.getContext('2d');
    let width, height, stars=[]; function resize(){width=window.innerWidth;height=window.innerHeight;canvas.width=width;canvas.height=height;} window.addEventListener('resize', resize); resize();
    class Star { constructor(){this.reset();} reset(){this.x=Math.random()*width;this.y=Math.random()*height;this.size=Math.random()*1.5;this.alpha=Math.random();} update(){this.alpha+=Math.sin(Date.now()*0.001*(Math.random()*0.05))*0.01;} draw(){ctx.globalAlpha=Math.max(0.1,Math.abs(this.alpha));ctx.fillStyle='#fff';ctx.beginPath();ctx.arc(this.x,this.y,this.size,0,Math.PI*2);ctx.fill();} }
    for(let i=0;i<80;i++) stars.push(new Star()); function animate(){ctx.clearRect(0,0,width,height); stars.forEach(s=>{s.update();s.draw();}); requestAnimationFrame(animate);} animate();

    // --- Audio Main ---
    const KEY_NAMES_MAIN = ['C','Db','D','Eb','E','F','Gb','G','Ab','A','Bb','B'];
    const NOTE_FREQ = {}; for(let i=1;i<=8;i++) KEY_NAMES_MAIN.forEach((k,idx)=>NOTE_FREQ[`${k}${i}`]=440*Math.pow(2,(i*12+idx+12-69)/12));
    const SCORE_LIB = { 
        "七里香": { score: "5 0.75 5 0.25 6 0.5 5 0.5 3- 2 1 0.5 2 0.5 3 0.5 2 0.5 1 0.5 6- 0.5 1 1" },
        "天空之城": { score: "6- 0.5 7- 0.5 1 1.5 7- 0.5 1 1 3 1 7- 3 3 0.5 6- 1.5 5- 0.5 6- 1 1 1" },
        "晴天": { score: "3 0.5 2 0.5 3 0.5 2 0.5 3 1 3 0.5 2 0.5 3 0.5 2 0.5 5 1" }
    };
    let audioCtx, masterGain, micRecorder, micChunks=[], historyList=[], currentAudioElement=null, isPlaying=false, tempRecordingBlob=null;
    // For Visualizer
    let visAnalyser=null, visDataArray=null, visAnimId=null, visCtx=null;

    function initAudio() {
        if(!audioCtx) {
            audioCtx = new (window.AudioContext||window.webkitAudioContext)();
            masterGain = audioCtx.createGain(); masterGain.gain.value = 0.5;
            masterGain.connect(audioCtx.destination);
        }
        if(audioCtx.state==='suspended') audioCtx.resume();
    }

    function playTone(ctx, dest, note, time, duration, velocity=0.8) {
        if(!NOTE_FREQ[note]) return;
        const freq = NOTE_FREQ[note];
        const o1=ctx.createOscillator(), o2=ctx.createOscillator(), o3=ctx.createOscillator();
        o1.type='triangle'; o2.type='sine'; o3.type='sawtooth';
        o1.frequency.value=freq; o2.frequency.value=freq; o3.frequency.value=freq;
        o3.detune.value = 2;
        const filter = ctx.createBiquadFilter(); filter.type='lowpass';
        filter.frequency.setValueAtTime(freq * (2 + 4*velocity), time);
        filter.frequency.exponentialRampToValueAtTime(freq, time + duration * 0.5);
        const amp = ctx.createGain();
        amp.gain.setValueAtTime(0, time);
        amp.gain.linearRampToValueAtTime(velocity, time + 0.015);
        amp.gain.exponentialRampToValueAtTime(velocity*0.3, time + duration * 0.8);
        amp.gain.linearRampToValueAtTime(0, time + duration + 0.05);
        o1.connect(filter); o2.connect(filter); 
        const g3=ctx.createGain(); g3.gain.value=0.15; o3.connect(g3).connect(filter);
        filter.connect(amp); amp.connect(dest);
        const stopT = time + duration + 0.1;
        o1.start(time); o2.start(time); o3.start(time);
        o1.stop(stopT); o2.stop(stopT); o3.stop(stopT);
    }

    // --- Visualizer Logic ---
    function initVisualizer(stream) {
        if(!visCtx) {
            const c = document.getElementById('mic-visualizer');
            visCtx = c.getContext('2d');
        }
        const visAudioCtx = new (window.AudioContext||window.webkitAudioContext)();
        const source = visAudioCtx.createMediaStreamSource(stream);
        visAnalyser = visAudioCtx.createAnalyser();
        visAnalyser.fftSize = 2048;
        source.connect(visAnalyser);
        visDataArray = new Uint8Array(visAnalyser.frequencyBinCount);
        
        drawVisualizer();
    }

    function drawVisualizer() {
        if(!visAnalyser) return;
        visAnimId = requestAnimationFrame(drawVisualizer);
        visAnalyser.getByteTimeDomainData(visDataArray);
        
        const c = document.getElementById('mic-visualizer');
        const W = c.width; const H = c.height;
        visCtx.clearRect(0, 0, W, H);
        
        // Background Circle for target
        visCtx.beginPath();
        visCtx.arc(W/2, H/2, 60, 0, 2*Math.PI);
        visCtx.strokeStyle = 'rgba(255,255,255,0.1)';
        visCtx.lineWidth = 2;
        visCtx.stroke();
        
        // Calculate FFT to detect spectral flatness (simple approx)
        const fftData = new Uint8Array(visAnalyser.frequencyBinCount);
        visAnalyser.getByteFrequencyData(fftData);
        let sumAmp=0, sumLogAmp=0;
        for(let i=0; i<fftData.length; i++) {
            const val = fftData[i] + 1; // avoid log0
            sumAmp += val;
            sumLogAmp += Math.log(val);
        }
        const spectralFlatness = Math.exp(sumLogAmp/fftData.length) / (sumAmp/fftData.length);
        
        // RMS for Volume
        let sum = 0;
        for(let i=0; i<visDataArray.length; i++) {
            const v = (visDataArray[i] - 128) / 128;
            sum += v*v;
        }
        const rms = Math.sqrt(sum / visDataArray.length);
        
        // --- Target Dot Logic ---
        // Distance from center = Spectral Flatness * Scale
        const maxDist = 120;
        const dist = Math.min(maxDist, spectralFlatness * 400); 
        const angle = Date.now() * 0.005 + (Math.random()-0.5); 
        
        const targetX = W/2 + Math.cos(angle) * dist;
        const targetY = H/2 + Math.sin(angle) * dist;
        
        // Dynamic Color & Hint
        let dotColor = '#ffd700';
        let hintText = "很好 继续保持哼唱";
        
        if (rms < 0.02) {
             dotColor = '#555'; // Silence
             hintText = "聆听中...";
        } else if (dist > 80) { // High flatness = Noisy/Lyrics
             dotColor = '#ef4444'; // Red
             hintText = "歌词干扰 回到哼唱";
        } else {
             dotColor = '#22c55e'; // Green = Good Tone
             hintText = "很好 继续保持哼唱";
        }
        
        document.getElementById('timbre-hint').innerText = hintText;
        document.getElementById('timbre-hint').style.color = dotColor;

        // Draw Dot
        visCtx.beginPath();
        visCtx.arc(targetX, targetY, 8, 0, 2*Math.PI);
        visCtx.fillStyle = dotColor;
        visCtx.shadowBlur = 15;
        visCtx.shadowColor = dotColor;
        visCtx.fill();
        visCtx.shadowBlur = 0;
    }

    function stopVisualizer() {
        if(visAnimId) cancelAnimationFrame(visAnimId);
    }

    // --- Recording ---
    const micBtn=document.getElementById('mic-btn'), diskStatus=document.getElementById('disk-status'), previewModal=document.getElementById('preview-modal');
    micBtn.addEventListener('touchstart', (e)=>{ e.preventDefault(); startRec(); }, {passive:false});
    micBtn.addEventListener('touchend', stopRec);
    micBtn.addEventListener('mousedown', startRec); 
    document.addEventListener('mouseup', stopRec); 

    async function startRec() {
        if(document.getElementById('panel-hum').classList.contains('hidden')) return;
        try {
            document.getElementById('recording-hint-overlay').classList.add('show');
            const s = await navigator.mediaDevices.getUserMedia({
                audio: { echoCancellation: false, noiseSuppression: false, autoGainControl: false, sampleRate: 48000 }
            });
            
            initVisualizer(s);

            micRecorder = new MediaRecorder(s); micChunks=[];
            micRecorder.ondataavailable = e => micChunks.push(e.data);
            micRecorder.onstop = showPreview;
            micRecorder.start();
            micBtn.classList.add('recording');
        } catch(e) { 
            alert("Mic Error: " + e.message); 
            document.getElementById('recording-hint-overlay').classList.remove('show');
        }
    }
    function stopRec() { 
        if(micRecorder && micRecorder.state==='recording') { 
            micRecorder.stop(); 
            micBtn.classList.remove('recording'); 
            stopVisualizer();
            document.getElementById('recording-hint-overlay').classList.remove('show');
        } 
    }
    
    function showPreview() { tempRecordingBlob = new Blob(micChunks, { type: 'audio/webm' }); previewModal.classList.add('show'); }
    function playPreview() { if(tempRecordingBlob) new Audio(URL.createObjectURL(tempRecordingBlob)).play(); }
    function discardRecording() { tempRecordingBlob=null; micChunks=[]; previewModal.classList.remove('show'); diskStatus.innerText="READY"; }
    async function confirmRecording() {
        // Fix: Resume AudioContext here to enable sound on mobile
        initAudio();
        // Create an empty buffer and play it to unlock audio engine on iOS/Android
        const buffer = audioCtx.createBuffer(1, 1, 22050);
        const source = audioCtx.createBufferSource();
        source.buffer = buffer;
        source.connect(audioCtx.destination);
        source.start(0);

        previewModal.classList.remove('show');
        const ab = await tempRecordingBlob.arrayBuffer();
        
        const audBuf = await audioCtx.decodeAudioData(ab);
        startProcessing(audBuf.getChannelData(0), audBuf.sampleRate, "Voice " + new Date().toLocaleTimeString('en-GB',{hour:'2-digit',minute:'2-digit'}));
    }
    async function handleFileUpload(input) {
        if(!input.files[0]) return;
        const ab = await input.files[0].arrayBuffer();
        initAudio(); // Activate context
        const audBuf = await audioCtx.decodeAudioData(ab);
        startProcessing(audBuf.getChannelData(0), audBuf.sampleRate, input.files[0].name.replace(/\.[^/.]+$/, ""));
    }

    function startProcessing(pcm, sr, title) {
        document.getElementById('processing-overlay').classList.add('show');
        audioWorker.postMessage({ audioData: pcm, sampleRate: sr });
        audioWorker.onmessage = function(e) {
            if(e.data.progress) { 
                document.getElementById('overlay-progress').style.width = (e.data.progress * 100) + '%'; 
            }
            else if (e.data.notes) {
                document.getElementById('processing-overlay').classList.remove('show');
                setTimeout(() => document.getElementById('overlay-progress').style.width = '0%', 500);
                if(e.data.notes.length === 0) { diskStatus.innerText = "NO MELODY"; return; }
                generateResult(e.data.notes, title);
            }
        };
    }

    let generatedAudioBuffer = null;
    async function generateResult(notes, title) {
        const tEl = document.getElementById('disk-title'); if(tEl) tEl.innerText = title;
        diskStatus.innerText = "RENDERING...";
        document.getElementById('processing-overlay').classList.add('show');
        document.getElementById('processing-text').innerText = "正在谱写乐章...";
        
        let totalDur = 0; notes.forEach(n=>totalDur+=n.duration);
        const offCtx = new OfflineAudioContext(1, 44100 * (totalDur + 2), 44100);
        
        const masterComp = offCtx.createDynamicsCompressor();
        masterComp.threshold.value = -20;
        masterComp.ratio.value = 10;
        masterComp.connect(offCtx.destination);

        let now = 0;
        notes.forEach(n => {
            playTone(offCtx, masterComp, n.note, now, n.duration, n.velocity||0.8);
            now += n.duration;
        });
        
        const buffer = await offCtx.startRendering();
        generatedAudioBuffer = buffer;
        const mp3Blob = bufferToMp3(buffer);
        
        document.getElementById('processing-overlay').classList.remove('show');
        document.getElementById('processing-text').innerText = "正在分析音频特征...";
        
        const id = Date.now();
        historyList.unshift({ id, title, notes, blob: mp3Blob });
        renderHistory();
        playBlob(mp3Blob);
        document.getElementById('btn-dl-mp3').disabled = false;
        document.getElementById('btn-dl-pdf').disabled = false;
    }

    function bufferToMp3(buffer) {
        const enc = new lamejs.Mp3Encoder(1, 44100, 128);
        const s = buffer.getChannelData(0);
        const i16 = new Int16Array(s.length);
        for(let i=0;i<s.length;i++) i16[i] = s[i]<0?s[i]*0x8000:s[i]*0x7FFF;
        const d = [];
        for(let i=0; i<i16.length; i+=1152) {
            const b = enc.encodeBuffer(i16.subarray(i, i+1152));
            if(b.length>0) d.push(b);
        }
        const e = enc.flush(); if(e.length>0) d.push(e);
        return new Blob(d, {type:'audio/mp3'});
    }

    function togglePlayback() {
        if(!currentAudioElement) return;
        if(currentAudioElement.paused) { currentAudioElement.play(); setPlayingState(true); }
        else { currentAudioElement.pause(); setPlayingState(false); }
    }
    function playBlob(blob) {
        if(currentAudioElement) { currentAudioElement.pause(); currentAudioElement=null; }
        const url=URL.createObjectURL(blob); const audio=new Audio(url);
        currentAudioElement=audio; audio.play(); setPlayingState(true);
        audio.onended = () => setPlayingState(false);
    }
    function setPlayingState(bool) {
        if(bool) { document.body.classList.add('is-playing'); document.querySelector('.tonearm').style.transform = 'rotate(15deg)'; diskStatus.innerText = "PLAYING"; }
        else { document.body.classList.remove('is-playing'); diskStatus.innerText = "PAUSED"; }
    }

    // UI Control
    function setMode(m) {
        document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active')); event.target.classList.add('active');
        document.getElementById('panel-hum').classList.add('hidden'); document.getElementById('panel-input').classList.add('hidden');
        if(m==='hum') {
            document.getElementById('panel-hum').classList.remove('hidden');
        } else { 
            document.getElementById('panel-input').classList.remove('hidden'); 
            window.inputMode = m; 
            document.getElementById('text-input').placeholder = "输入歌名 (如: 七里香)..."; 
        }
    }
    window.setMode = setMode;
    
    // --- 修复的 GenerateFromText (Maestro Edition) ---
    function generateFromText() {
        const val = document.getElementById('text-input').value.trim();
        if (!val) return;
        let notes = [];

        // Unlock audio context
        initAudio();
        // Play silent buffer to unlock
        const buffer = audioCtx.createBuffer(1, 1, 22050);
        const source = audioCtx.createBufferSource();
        source.buffer = buffer;
        source.connect(audioCtx.destination);
        source.start(0);

        if (SCORE_LIB[val]) {
            // 已收录曲目：直接解析
            notes = parseScore(SCORE_LIB[val].score);
        } else {
            // 未收录曲目：AI 乐理生成 (Music Theory Model)
            // 确保生成好听的旋律 (C Major / I-IV-V-vi)
            const chords = [
                [60, 64, 67], // C (I)
                [65, 69, 72], // F (IV)
                [67, 71, 62], // G (V)
                [69, 72, 64]  // Am (vi)
            ];
            
            // 4 bars
            for (let bar = 0; bar < 4; bar++) {
                const chord = chords[bar % 4];
                let beat = 0;
                while (beat < 4) {
                    // Choose chord tone or passing tone
                    let midi = chord[Math.floor(Math.random() * chord.length)];
                    // Add some passing tones (pentatonic)
                    if (Math.random() > 0.7) {
                        const penta = [60, 62, 64, 67, 69];
                        midi = penta[Math.floor(Math.random()*penta.length)];
                    }
                    
                    // Octave variation
                    if (Math.random() > 0.8) midi += 12;
                    if (Math.random() > 0.9) midi -= 12;

                    const dur = Math.random() > 0.6 ? 0.5 : 1.0;
                    if (beat + dur > 4) continue; // Don't overflow bar

                    const name = KEY_NAMES_MAIN[midi%12] + (Math.floor(midi/12)-1);
                    notes.push({ note: name, duration: dur, velocity: 0.6 + Math.random()*0.3 });
                    beat += dur;
                }
            }
        }
        
        generateResult(notes, val || "Melodic AI");
    }
    window.generateFromText = generateFromText;

    // 解析简谱 (支持 1 0.5 格式)
    function parseScore(str) {
        const tokens = str.split(/\s+/);
        const notes = [];
        for (let i = 0; i < tokens.length; i++) {
            let t = tokens[i];
            if (/[1-7]/.test(t)) {
                const map = { '1': 0, '2': 2, '3': 4, '4': 5, '5': 7, '6': 9, '7': 11 };
                let m = 72 + map[t.match(/[1-7]/)[0]]; // C5 Base
                if (t.includes('-')) m -= 12;
                if (t.includes('+')) m += 12;
                
                let dur = 0.5;
                if (i + 1 < tokens.length && /^[0-9.]+$/.test(tokens[i+1])) {
                    dur = parseFloat(tokens[i+1]);
                    i++; 
                }
                notes.push({
                    note: KEY_NAMES_MAIN[m % 12] + (Math.floor(m / 12) - 1),
                    duration: dur,
                    velocity: 0.75
                });
            }
        }
        return notes;
    }

    // Downloads
    window.downloadMP3 = (id) => { 
        const targetId = typeof id === 'number' ? id : (historyList.length > 0 ? historyList[0].id : null);
        if (!targetId) return;
        const item = historyList.find(i => i.id === targetId);
        if (item) { const a = document.createElement('a'); a.href = URL.createObjectURL(item.blob); a.download = `${item.title}.mp3`; a.click(); }
    };

    // --- 修复的五线谱绘制 (Maestro Engine) ---
    window.downloadSheetMusicPDF = (id) => { 
        const targetId = typeof id === 'number' ? id : (historyList.length > 0 ? historyList[0].id : null);
        if (!targetId) return;
        const item = historyList.find(i => i.id === targetId);
        if (!item) return;

        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('l','mm','a4');
        doc.setFontSize(22); doc.text(item.title, 148, 20, {align:"center"});
        
        const staffYBase = 60;
        const lineH = 2.5; 
        const staffW = 260; 
        const marginX = 20;

        let cursorX = marginX + 30; 
        let cursorY = staffYBase;

        function drawSystem(y) {
            doc.setLineWidth(0.3);
            for(let i=0; i<5; i++) doc.line(marginX, y + i*lineH, marginX + staffW, y + i*lineH);
            doc.line(marginX, y, marginX, y + 4*lineH); 
            doc.line(marginX+staffW, y, marginX+staffW, y + 4*lineH);
            doc.setFontSize(30); doc.text("G", marginX+5, y+18); 
            doc.setFontSize(12); doc.text("4", marginX+20, y+8); doc.text("4", marginX+20, y+16);
            return marginX + 35;
        }
        cursorX = drawSystem(cursorY);

        // F5 (Top Line) = MIDI 77
        const f5Index = 5*7 + 3; // 38
        
        function getDiatonicIndex(noteName) {
            // Fix: Remove Accidentals for positioning
            const char = noteName.charAt(0); // Take first char
            const octStr = noteName.match(/-?\d+/);
            const oct = octStr ? parseInt(octStr[0]) : 4;
            const baseMap = {'C':0,'D':1,'E':2,'F':3,'G':4,'A':5,'B':6};
            return oct * 7 + (baseMap[char] || 0);
        }
        
        let beatAccum = 0;
        
        item.notes.forEach(n => {
            if (cursorX > marginX + staffW - 20) {
                cursorX = marginX + 30; cursorY += 40;
                if (cursorY > 180) { doc.addPage(); cursorY = staffYBase; }
                drawSystem(cursorY);
            }

            const idx = getDiatonicIndex(n.note);
            const stepsFromF5 = f5Index - idx; 
            const noteY = cursorY + (stepsFromF5 * (lineH / 2));

            // Ledger Lines
            if (idx >= 40) { // A5+
                for (let i = 40; i <= idx; i+=2) {
                    const ly = cursorY + ((f5Index - i) * lineH / 2);
                    doc.line(cursorX-2, ly, cursorX+5, ly);
                }
            }
            if (idx <= 28) { // C4-
                for (let i = 28; i >= idx; i-=2) {
                    const ly = cursorY + ((f5Index - i) * lineH / 2);
                    doc.line(cursorX-2, ly, cursorX+5, ly);
                }
            }

            // Note Head
            doc.ellipse(cursorX+1.5, noteY, 1.6, 1.2, 'F');
            
            // Accidental (Sharp/Flat) - Simplified detection
            if(n.note.includes('b')) doc.text("b", cursorX-2, noteY+1);
            if(n.note.includes('#')) doc.text("#", cursorX-2, noteY+1);

            // Stem
            if (idx >= 34) doc.line(cursorX+0.3, noteY, cursorX+0.3, noteY+7); 
            else doc.line(cursorX+2.7, noteY, cursorX+2.7, noteY-7); 

            cursorX += 12;
            
            beatAccum += n.duration * 2; 
            if(beatAccum >= 4) {
                doc.line(cursorX-2, cursorY, cursorX-2, cursorY + 4*lineH);
                beatAccum = 0;
            }
        });

        doc.save(item.title+".pdf");
    };

    function renderHistory() {
        const l = document.getElementById('history-list'); 
        l.innerHTML = '';
        historyList.forEach(item => {
            const d = document.createElement('div'); 
            d.className = 'history-card interactive-hover';
            d.innerHTML = `
                <div class="h-info" onclick="replay(${item.id})">
                    <h4>${item.title}</h4>
                    <p>${item.notes.length} Notes</p>
                </div>
                <div class="h-actions">
                    <button class="icon-btn play-btn" onclick="replay(${item.id})">
                        <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                    </button>
                    <button class="icon-btn" onclick="downloadMP3(${item.id})" title="下载 MP3">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                    </button>
                    <button class="icon-btn" onclick="downloadSheetMusicPDF(${item.id})" title="下载乐谱">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                    </button>
                </div>`;
            l.appendChild(d);
        });
    }
    window.replay = (id) => { const i=historyList.find(x=>x.id===id); if(i){ playBlob(i.blob); showToast("回放历史记录"); document.getElementById('disk-title').innerText=i.title; } };
    window.onbeforeunload = () => historyList.length > 0 ? "Unsaved" : undefined;
</script>
</body>
</html>