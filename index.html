<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>To Scorpio: 星辰軌跡</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* 字体引入 */
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Cormorant+Garamond:ital,wght@0,300;0,600;1,400&family=Noto+Serif+TC:wght@300;500;700&display=swap');

        :root {
            --color-deep-space: #050510;
            --color-star-glow: rgba(255, 255, 255, 0.8);
            --glass-border: rgba(255, 255, 255, 0.1);
            --mystic-gold: #e6c288;
            --mystic-purple: rgba(147, 112, 219, 0.3);
        }

        body {
            margin: 0;
            overflow: hidden;
            background-color: var(--color-deep-space);
            font-family: 'Noto Serif TC', serif; 
            color: #E0E0E0;
            /* 关键：防止手机端长按选中文本 */
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            -webkit-touch-callout: none;
            -webkit-tap-highlight-color: transparent;
        }

        #canvas-bg {
            position: fixed;
            top: 0; left: 0;
            z-index: 0;
            pointer-events: auto; 
        }

        #game-ui {
            position: relative; z-index: 10;
            width: 100vw; height: 100vh;
            display: flex; justify-content: center; align-items: center;
            transition: opacity 0.5s ease;
            pointer-events: none;
        }
        
        #game-ui > * {
            pointer-events: auto;
        }

        /* 字体类 */
        .title-font { font-family: 'Cinzel', serif; letter-spacing: 0.2em; text-shadow: 0 0 20px rgba(224, 195, 252, 0.4); }
        .elegant-text { font-family: 'Cormorant Garamond', 'Noto Serif TC', serif; letter-spacing: 0.05em; }
        .tc-font { font-family: 'Noto Serif TC', serif; }

        /* 玻璃面板通用样式 */
        .glass-panel {
            backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px);
            background: rgba(20, 20, 35, 0.6);
            border: 1px solid var(--glass-border);
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5), inset 0 0 20px rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            position: relative; overflow: hidden;
        }

        /* --- Radio UI Styles (Stage 8) - Dreamy/Mysterious Style --- */
        .radio-interface {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            max-width: 400px;
            padding: 2rem;
            /* 梦幻的深紫/金色调 */
            background: linear-gradient(145deg, rgba(40, 30, 60, 0.8), rgba(10, 10, 20, 0.9));
            border: 1px solid rgba(255, 215, 0, 0.2);
            border-radius: 50% 50% 20px 20px; /* 拱门形状 */
            box-shadow: 
                0 0 30px rgba(147, 112, 219, 0.2),
                inset 0 0 50px rgba(0,0,0,0.5);
            position: relative;
            pointer-events: auto;
        }
        
        /* 装饰性边框 */
        .radio-interface::before {
            content: ''; position: absolute; top: 10px; left: 10px; right: 10px; bottom: 10px;
            border: 1px dashed rgba(255, 215, 0, 0.1);
            border-radius: 50% 50% 15px 15px;
            pointer-events: none;
        }

        /* Frequency Display */
        .freq-display {
            font-family: 'Cormorant Garamond', serif;
            font-size: 3.5rem;
            color: var(--mystic-gold);
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.6);
            margin-bottom: 2rem;
            text-align: center;
            font-variant-numeric: tabular-nums;
        }
        .freq-unit { font-size: 1.2rem; opacity: 0.8; font-family: 'Cinzel', serif; margin-left: 5px; color: #fff; }

        /* The Mystic Knob */
        .knob-container {
            position: relative;
            width: 180px;
            height: 180px;
            margin: 0 auto 2rem auto;
        }
        .knob-base {
            width: 100%; height: 100%;
            border-radius: 50%;
            /* 星盘底座 */
            background: radial-gradient(circle, #2a1a3a, #000);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 0 20px rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .knob-dial {
            width: 85%; height: 85%;
            border-radius: 50%;
            /* 水晶球质感 */
            background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.1), rgba(147, 112, 219, 0.2) 60%, rgba(0,0,0,0.8));
            border: 1px solid rgba(255, 215, 0, 0.3);
            box-shadow: inset 0 0 15px rgba(255, 215, 0, 0.1);
            cursor: grab;
            position: relative;
            transition: transform 0.1s cubic-bezier(0.1, 0.7, 1.0, 0.1);
        }
        .knob-dial:active { cursor: grabbing; }
        
        /* 旋钮指针 - 星星 */
        .knob-indicator {
            position: absolute;
            top: 5px;
            left: 50%;
            transform: translateX(-50%);
            width: 10px; height: 10px;
            background: #fff;
            border-radius: 50%;
            box-shadow: 0 0 10px #fff, 0 0 20px var(--mystic-gold);
        }
        /* 旋钮上的装饰线 */
        .knob-dial::after {
            content: ''; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 60%; height: 60%;
            border: 1px dotted rgba(255, 255, 255, 0.3);
            border-radius: 50%;
        }

        /* Controls */
        .control-row {
            display: flex;
            gap: 20px;
            width: 100%;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
            z-index: 10;
        }
        .mini-control {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            flex: 1;
        }
        .control-label {
            font-family: 'Cinzel', serif;
            font-size: 0.6rem;
            color: var(--mystic-gold);
            text-transform: uppercase;
            letter-spacing: 2px;
        }
        
        input[type=range] {
            -webkit-appearance: none;
            width: 100%;
            background: transparent;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 10px; width: 10px;
            border-radius: 50%;
            background: var(--mystic-gold);
            cursor: pointer;
            margin-top: -3px;
            box-shadow: 0 0 8px var(--mystic-gold);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 4px;
            cursor: pointer;
            background: rgba(255,255,255,0.1);
            border-radius: 2px;
        }

        .icon-btn {
            background: transparent;
            border: 1px solid rgba(255, 215, 0, 0.3);
            color: var(--mystic-gold);
            width: 44px; height: 44px;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        .icon-btn:hover {
            background: rgba(255, 215, 0, 0.1);
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.2);
            transform: scale(1.1);
        }

        /* 玻璃罐子样式 */
        .glass-jar-container {
            position: absolute;
            bottom: 10%;
            left: 50%;
            transform: translateX(-50%);
            width: 160px; 
            height: 200px;
            z-index: 5;
            pointer-events: none;
            transition: all 0.3s ease;
        }
        .glass-jar {
            width: 100%; height: 100%;
            background: linear-gradient(135deg, rgba(255,255,255,0.05) 0%, rgba(255,255,255,0.01) 50%, rgba(255,255,255,0.05) 100%);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-top: none; 
            border-radius: 5px 5px 30px 30px; 
            backdrop-filter: blur(2px);
            box-shadow: inset 10px 0 20px rgba(255, 255, 255, 0.1), inset -10px 0 20px rgba(0, 0, 0, 0.2), inset 0 -15px 30px rgba(0, 0, 0, 0.3), 0 15px 30px rgba(0, 0, 0, 0.5); 
            position: relative;
        }
        .glass-jar::before {
            content: ''; position: absolute; top: 0; left: 0; right: 0; height: 15px;
            border: 2px solid rgba(255, 255, 255, 0.4); border-radius: 50%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            transform: translateY(-50%); 
        }
        .glass-jar::after {
            content: ''; position: absolute; top: 20px; left: 15px; width: 10px; height: 80%;
            background: linear-gradient(to bottom, rgba(255,255,255,0.4), transparent);
            border-radius: 50px; filter: blur(2px); opacity: 0.6;
        }

        /* 按钮 */
        .star-btn {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(224, 195, 252, 0.3);
            color: #e0c3fc;
            transition: all 0.5s cubic-bezier(0.22, 1, 0.36, 1);
            position: relative; overflow: hidden; font-family: 'Cinzel', serif;
            cursor: pointer;
        }
        .star-btn:hover {
            border-color: #fff; background: rgba(224, 195, 252, 0.15);
            text-shadow: 0 0 10px #e0c3fc; letter-spacing: 0.4em;
            box-shadow: 0 0 20px rgba(224, 195, 252, 0.2);
        }

        /* 动画类 */
        .hidden { display: none !important; }
        .fade-enter { opacity: 0; transform: translateY(20px); filter: blur(5px); }
        .fade-enter-active { opacity: 1; transform: translateY(0); filter: blur(0); transition: all 1.2s ease-out; }
        .fade-exit { opacity: 1; transform: scale(1); filter: blur(0); }
        .fade-exit-active { opacity: 0; transform: scale(1.1); filter: blur(10px); transition: all 0.8s ease-in; }

        /* Stage -1: Qzz 样式优化 */
        .qzz-char {
            position: absolute;
            font-size: 1.5rem; /* 调小字体 */
            color: rgba(255, 255, 255, 0.8);
            font-family: 'Noto Serif TC', serif; /* 思源宋体 */
            cursor: pointer;
            text-shadow: 0 0 5px rgba(255, 255, 255, 0.5);
            animation: qzzFloat 3s ease-in-out infinite alternate;
            padding: 30px; /* 增大点击热区 */
            transition: color 0.3s;
        }
        .qzz-char:hover {
            color: #fff;
            text-shadow: 0 0 15px rgba(255, 255, 255, 1);
        }
        @keyframes qzzFloat {
            0% { transform: translateY(0) scale(1); opacity: 0.6; }
            100% { transform: translateY(-10px) scale(1.1); opacity: 1; }
        }

        .lucky-text {
            font-family: 'Noto Serif TC', serif;
            color: #ffd700;
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.8), 0 0 40px rgba(255, 215, 0, 0.4);
            font-size: 3rem;
            letter-spacing: 0.2em;
            opacity: 0;
            transform: scale(0.9);
            transition: all 1.5s ease-out;
            pointer-events: none;
        }

        /* Stage 1: Icons 优化 */
        .mem-icon {
            position: absolute;
            width: 50px; height: 50px;
            display: flex; align-items: center; justify-content: center;
            filter: drop-shadow(0 0 5px rgba(255, 255, 255, 0.4));
            cursor: pointer;
            will-change: transform, top, left, opacity;
            z-index: 20; /* Ensure clickable */
        }
        .mem-icon:hover { 
            filter: drop-shadow(0 0 15px rgba(255, 255, 255, 0.9)); 
            z-index: 50;
        }

        /* Stage 5: Heart Pulse */
        .heart-active {
            filter: drop-shadow(0 0 20px #ff4d6d) drop-shadow(0 0 40px #ff4d6d) !important;
            transform: scale(1.15) !important;
            color: #fff !important;
        }

        /* 拼图相关样式 (优化手机端) */
        .puzzle-slot { transition: background 0.3s, border-color 0.3s; }
        .puzzle-piece { transition: transform 0.2s, box-shadow 0.2s; }
        .puzzle-piece.selected { box-shadow: 0 0 0 3px #ffd700, 0 0 20px #ffd700; transform: scale(1.1); z-index: 100; }

        /* Utility */
        #skip-arrow {
            position: fixed; bottom: 30px; right: 30px; z-index: 100;
            color: rgba(255, 255, 255, 0.3); font-size: 1.5rem; cursor: pointer;
            transition: all 0.3s; padding: 10px; border-radius: 50%; pointer-events: auto;
        }
        #skip-arrow:hover { color: rgba(255, 255, 255, 1); background: rgba(255,255,255,0.1); }
        
        /* 字幕容器样式 - 放在标题下方空白处 */
        #subtitle-container {
            position: absolute;
            top: 15%; /* 靠上方区域 */
            left: 50%;
            transform: translateX(-50%);
            width: 80%; /* 限制宽度 */
            height: 30%; /* 限制高度区域 */
            pointer-events: none; /* 穿透点击 */
            z-index: 40;
            /* 不需要 flex 布局，因为子元素绝对定位 */
        }
        
        /* 独立的歌词字符样式 - 散落星尘 */
        .lyric-char {
            position: absolute; /* 绝对定位实现散落 */
            font-family: 'Noto Serif TC', serif;
            font-size: 1.1rem; 
            color: rgba(255, 255, 255, 0.95);
            text-shadow: 0 0 5px rgba(255, 215, 0, 0.8), 0 0 10px rgba(255, 255, 255, 0.5);
            white-space: pre; 
            will-change: transform, opacity, filter;
            opacity: 0;
            /* 复合动画：淡入 + 缓慢晃动 + 闪烁 */
            animation: 
                charFadeIn 1.5s ease forwards, 
                charFloat 8s ease-in-out infinite alternate,
                charTwinkle 3s ease-in-out infinite;
        }

        @keyframes charFadeIn {
            0% { opacity: 0; transform: scale(0); }
            100% { opacity: 1; transform: scale(1); }
        }

        @keyframes charFloat {
            0% { margin-top: 0px; margin-left: 0px; transform: rotate(0deg); }
            33% { margin-top: -5px; margin-left: 3px; transform: rotate(2deg); }
            66% { margin-top: 5px; margin-left: -3px; transform: rotate(-1deg); }
            100% { margin-top: 2px; margin-left: 2px; transform: rotate(1deg); }
        }

        @keyframes charTwinkle {
            0%, 100% { opacity: 1; text-shadow: 0 0 5px rgba(255, 215, 0, 0.8); }
            50% { opacity: 0.7; text-shadow: 0 0 15px rgba(255, 255, 255, 0.3); }
        }

        /* 手机端竖屏优化媒体查询 */
        @media (max-width: 768px) {
            .title-font { font-size: 3rem !important; }
            .tc-font { font-size: 1rem !important; }
            .glass-jar-container { width: 120px; height: 160px; bottom: 15%; }
            #stage-0 { padding: 20px !important; margin: 20px; }
            .puzzle-layout { flex-direction: column !important; gap: 2rem !important; }
            #puzzle-pieces { grid-template-columns: repeat(4, 1fr) !important; width: 100% !important; gap: 0.5rem !important; }
            .puzzle-piece, .puzzle-slot { width: 70px !important; height: 70px !important; }
            #game-ui h2 { font-size: 2rem !important; }
            
            .lyric-char { font-size: 0.9rem; }
            #subtitle-container { top: 20%; width: 90%; }
            
            /* Radio Mobile Adjustments */
            .radio-interface { width: 90%; padding: 1.5rem; border-radius: 40px 40px 20px 20px; }
            .knob-container { width: 180px; height: 180px; }
            .freq-display { font-size: 2.5rem; }
        }
    </style>
</head>
<body>

    <canvas id="canvas-bg"></canvas>
    
    <!-- 背景音乐：移除 crossorigin 属性以兼容 GitHub Raw 链接 -->
    <audio id="bgm" loop>
        <source src="https://raw.githubusercontent.com/2314696760-cmd/qlxbgm/b87e7d2ed3e5d989dc52013af7d49bbbd97e470d/qlxx.mp3" type="audio/mpeg">
        Your browser does not support the audio element.
    </audio>
    
    <!-- 跳过按钮 -->
    <div id="skip-arrow" onclick="game.nextStage()" title="Next Step">
        <i class="fas fa-chevron-right"></i>
    </div>

    <div id="game-ui">
        
        <!-- 字幕容器 (散落区域) -->
        <div id="subtitle-container"></div>

        <!-- Stage -1: Qzz Intro -->
        <div id="stage-pre" class="stage-container w-full h-full relative flex items-center justify-center">
            <div id="qzz-container" class="absolute inset-0 pointer-events-none"></div>
            <h1 id="lucky-msg" class="lucky-text absolute z-20 pointer-events-none">2026 Lucky</h1>
        </div>

        <!-- Stage 0: Title -->
        <div id="stage-0" class="stage-container hidden glass-panel text-center max-w-4xl p-16 mx-4">
            <div class="mb-12 relative group">
                <div class="absolute -inset-4 bg-gradient-to-r from-purple-900 to-red-900 rounded-full blur-xl opacity-20 group-hover:opacity-30 transition duration-1000"></div>
                <h1 class="relative text-6xl md:text-8xl mb-4 title-font text-white tracking-widest font-thin">CELESTIAL</h1>
                <div class="flex items-center justify-center gap-4 text-purple-200/60 mt-6">
                    <span class="h-[1px] w-12 bg-purple-200/30"></span>
                    <p class="text-sm tracking-[0.4em] uppercase font-light tc-font">Cancer & Scorpio</p>
                    <span class="h-[1px] w-12 bg-purple-200/30"></span>
                </div>
            </div>
            
            <p class="text-xl mb-16 text-gray-300 font-light leading-loose elegant-text italic">
                「在這片混沌的宇宙中，<br>
                我試圖尋找與妳引力重合的軌跡。」
            </p>
            
            <button onclick="startGameSequence()" class="star-btn px-12 py-4 text-sm font-bold rounded-sm tracking-[0.3em] uppercase">
                Start Journey
            </button>
        </div>

        <!-- Stage 1: Memory Icons & Jar -->
        <div id="stage-1" class="stage-container hidden w-full h-full relative">
            <div class="absolute top-16 w-full text-center pointer-events-none z-20">
                <h2 class="text-4xl title-font text-purple-100/90 mb-2">Collection</h2>
                <p class="tc-font text-lg text-purple-300/60 tracking-[0.5em]" id="stage1-text">存入罐子里的甜蜜 (0/11)</p>
            </div>
            
            <!-- 毛玻璃罐子 -->
            <div class="glass-jar-container" id="jar-target">
                <div class="glass-jar"></div>
            </div>
        </div>

        <!-- Stage 2: Orbit -->
        <div id="stage-2" class="stage-container hidden w-full h-full flex flex-col items-center justify-center">
             <div class="absolute top-16 text-center pointer-events-none z-20">
                <h2 class="text-4xl title-font text-blue-100/90 mb-2">Resonance</h2>
                <p class="tc-font text-lg text-blue-300/60 tracking-[0.5em]">引力同頻 · 心跳同步</p>
            </div>
            <div class="relative w-[90vw] h-[90vw] max-w-[600px] max-h-[600px] flex items-center justify-center pointer-events-none">
                <canvas id="orbit-canvas" width="600" height="600" class="z-10 w-full h-full"></canvas>
            </div>
            <div class="absolute bottom-24 w-80 glass-panel px-8 py-6 z-50">
                <input type="range" min="50" max="250" value="50" class="w-full cursor-pointer opacity-80 hover:opacity-100 transition-opacity accent-purple-400" id="orbit-slider">
            </div>
        </div>

        <!-- Stage 3: Big Dipper -->
        <div id="stage-3" class="stage-container hidden w-full h-full relative cursor-crosshair">
            <div class="absolute top-16 left-0 w-full text-center pointer-events-none z-30" id="st3-title">
                <h2 class="text-4xl title-font text-purple-100/90 mb-2">Guidance</h2>
                <p class="tc-font text-lg text-purple-300/60 tracking-[0.5em]">連結北斗 · 指引方向</p>
            </div>
            <canvas id="constellation-canvas" class="absolute top-0 left-0 w-full h-full z-20"></canvas>
        </div>

        <!-- Stage 4: Heart/Blackhole -->
        <div id="stage-4" class="stage-container hidden w-full h-full flex flex-col items-center justify-center relative overflow-hidden">
            <div class="absolute inset-0 bg-black/60 z-0"></div>
            <div class="z-20 text-center mb-24 pointer-events-none mix-blend-screen">
                <h2 class="text-5xl title-font text-red-700/80 tracking-widest mb-3">Heart</h2>
                <p class="tc-font text-lg text-red-900/60 tracking-[0.8em]">注入心意 · 點亮星核</p>
            </div>
            <div class="relative flex items-center justify-center group">
                <canvas id="heart-particle-canvas" width="600" height="600" class="absolute z-10 pointer-events-none"></canvas>
                <div id="blackhole-core" class="w-32 h-32 rounded-full bg-black shadow-[0_0_50px_rgba(100,0,0,0.3)] border border-red-900/30 z-20 relative transition-all duration-200 flex items-center justify-center">
                    <div class="w-full h-full rounded-full bg-red-900/20 opacity-0 transition-opacity duration-100" id="core-glow"></div>
                </div>
            </div>
            <button id="resist-btn" class="mt-32 w-28 h-28 rounded-full border border-white/10 bg-white/5 backdrop-blur-md shadow-[0_0_40px_rgba(255,255,255,0.05)] z-20 active:scale-95 transition-all flex items-center justify-center text-gray-300 font-serif text-lg tracking-[0.1em] select-none hover:bg-white/10 hover:text-white hover:border-white/30 cursor-pointer">
                Heart
            </button>
        </div>

        <!-- Stage 5: Rhythm -->
        <div id="stage-5" class="stage-container hidden w-full h-full flex flex-col items-center justify-center">
            <h2 class="text-4xl title-font text-red-100/90 mb-20 tracking-widest drop-shadow-[0_0_15px_rgba(255,50,50,0.3)]">Pulse</h2>
            <div class="relative w-96 h-96 flex items-center justify-center">
                <!-- Target Ring (Visual Aid only) -->
                <div id="heart-target" class="absolute w-full h-full border border-white/5 rounded-full scale-0 opacity-0"></div>
                
                <!-- Beat Button -->
                <div id="heart-beat" class="relative z-10 w-24 h-24 bg-gradient-to-t from-[#4a0e14] to-[#8a1c29] rounded-full shadow-[0_0_50px_rgba(138,28,41,0.5)] cursor-pointer flex items-center justify-center transition-transform active:scale-95 ring-1 ring-white/10">
                    <i class="fas fa-heart text-white/50 text-3xl transition-all duration-100" id="heart-icon"></i>
                </div>
            </div>
            <p class="mt-16 tc-font text-gray-500 text-sm tracking-[0.5em]">在愛心發光時觸碰 (0/5)</p>
        </div>

        <!-- Stage 6: Scratch -->
        <div id="stage-6" class="stage-container hidden w-full h-full flex flex-col items-center justify-center">
            <div class="absolute top-16 text-center pointer-events-none z-30">
                <h2 class="text-4xl title-font text-white/90 mb-2">Soul</h2>
                <p class="tc-font text-lg text-gray-400/50 tracking-[0.5em]">撥開迷霧 · 靈魂底色</p>
            </div>
            <div class="relative w-[340px] h-[480px] max-w-[90vw] p-3 glass-panel transform hover:scale-[1.02] transition-transform duration-700">
                <div class="absolute inset-0 m-3 bg-[#050510] flex items-center justify-center text-center p-8 border border-white/5">
                    <div>
                        <div class="text-6xl text-purple-500/20 mb-8 font-serif">❝</div>
                        <p class="elegant-text text-purple-100 text-xl leading-loose italic font-light">
                            In a world of monochrome,<br>
                            you are my<br>
                            <span class="text-transparent bg-clip-text bg-gradient-to-r from-purple-300 to-red-300 font-normal not-italic tracking-widest border-b border-purple-500/30 pb-1">Spectrum.</span>
                        </p>
                        <div class="text-6xl text-purple-500/20 mt-8 font-serif transform rotate-180">❝</div>
                    </div>
                </div>
                <canvas id="scratch-canvas" class="absolute inset-0 m-3 cursor-pointer touch-none z-10 mix-blend-hard-light"></canvas>
            </div>
        </div>

        <!-- Stage 7: Heat Scrub -->
        <div id="stage-7" class="stage-container hidden w-full h-full flex flex-col items-center justify-center">
            <h2 class="text-4xl title-font text-cyan-100/90 mb-16 pointer-events-none">Warmth</h2>
            <div class="relative w-80 h-80 group">
                <div class="absolute inset-0 flex items-center justify-center" id="shield-reveal">
                    <div class="text-center">
                        <div class="w-32 h-32 mx-auto mb-6 bg-gradient-to-tr from-gray-100 to-gray-400 rounded-full flex items-center justify-center shadow-[0_0_40px_rgba(255,255,255,0.2)]">
                             <i class="fas fa-shield-alt text-5xl text-gray-800"></i>
                        </div>
                        <p class="text-xs tracking-[0.4em] text-cyan-100 uppercase font-light">Guardian Activated</p>
                    </div>
                </div>
                <canvas id="heat-canvas" width="320" height="320" class="absolute inset-0 rounded-full z-10 shadow-[0_0_60px_rgba(0,255,255,0.1)]"></canvas>
                <p class="absolute -bottom-16 w-full text-center text-xs text-cyan-200/50 tracking-[0.3em] uppercase animate-pulse">Rub to melt the ice</p>
            </div>
        </div>

        <!-- Stage 8: Star Radio (RE-DESIGNED: Mystic) -->
        <div id="stage-8" class="stage-container hidden w-full h-full flex flex-col items-center justify-center">
            <!-- Header with Title and Target Subtitle -->
            <div class="text-center mb-8">
                <h2 class="text-4xl title-font text-emerald-100/90">Star Radio</h2>
                <span class="text-sm opacity-50 block mt-2 tracking-[0.2em] font-light" style="color: var(--neon-blue);">TARGET: 52.7 MHz</span>
            </div>
            
            <div class="radio-interface">
                <!-- Frequency Display -->
                <div class="freq-display">
                    <span id="freq-val">40.0</span><span class="freq-unit">MHz</span>
                </div>

                <!-- Tuning Knob with Integrated Visualizer -->
                <div class="knob-container">
                    <div class="knob-base">
                        <canvas id="knob-visualizer" width="220" height="220"></canvas> <!-- Visualizer inside -->
                        <div class="knob-dial" id="radio-knob">
                            <div class="knob-indicator"></div>
                        </div>
                    </div>
                </div>

                <!-- Controls: Volume & Scatter -->
                <div class="control-row">
                    <div class="mini-control">
                        <span class="control-label">BGM Vol</span>
                        <input type="range" id="vol-slider" min="0" max="1" step="0.1" value="0.25">
                    </div>
                    <div class="mini-control">
                        <span class="control-label">Scatter</span>
                        <input type="range" id="scatter-slider" min="20" max="150" step="5" value="60"> 
                    </div>
                </div>

                <!-- Action Button: Replay -->
                <div class="control-row" style="justify-content: center; margin-top: 20px;">
                    <button class="icon-btn" id="replay-btn" title="Replay">
                        <i class="fas fa-redo"></i>
                    </button>
                </div>
            </div>

            <p id="freq-msg" class="mt-12 text-sm text-emerald-200/80 font-mono opacity-0 transition-opacity tracking-[0.5em] uppercase shadow-glow">Signal Acquired</p>
        </div>

        <!-- Stage 9: Puzzle -->
        <div id="stage-9" class="stage-container hidden w-full h-full flex flex-col items-center justify-center">
            <h2 class="text-4xl title-font text-yellow-100/90 mb-8 pointer-events-none">Reunion</h2>
            <!-- Updated Layout for Mobile -->
            <div class="flex flex-col xl:flex-row gap-8 items-center justify-center puzzle-layout">
                <div class="grid grid-cols-3 gap-1 p-3 glass-panel" id="puzzle-area"></div>
                <!-- Mobile instructions -->
                <p class="xl:hidden text-xs text-gray-500 -my-4">點擊碎片，再點擊格子</p>
                <div class="grid grid-cols-4 gap-4 w-[400px]" id="puzzle-pieces"></div>
            </div>
        </div>

        <!-- Stage 10: Finale -->
        <div id="stage-10" class="stage-container hidden w-full h-full relative overflow-hidden">
            <div class="absolute bottom-0 w-full h-1/5 bg-black z-10 blur-[4px] opacity-80" style="clip-path: polygon(0% 100%, 5% 85%, 10% 90%, 15% 80%, 25% 95%, 35% 85%, 45% 90%, 55% 80%, 65% 95%, 75% 85%, 85% 90%, 95% 80%, 100% 100%);"></div>
            <div class="absolute bottom-32 left-0 right-0 z-20 text-center px-4">
                <h1 class="text-5xl md:text-6xl tc-font font-bold final-message mb-8 opacity-0 transition-opacity duration-3000 leading-tight text-white/90 drop-shadow-2xl" id="final-text">
                    今夜は月が綺麗ですね
                </h1>
                <p class="text-purple-200/80 text-3xl opacity-0 transition-opacity duration-3000 tracking-[0.3em] tc-font" id="sub-final-text">
                    2026馬年快樂
                </p>
            </div>
        </div>

    </div>

    <script>
        // --- 歌词数据 (Updated: 七里香) ---
        const lrcData = `[00:31.00] 窗外的麻雀 在电线杆上多嘴
[00:37.67] 你说这一句 很有夏天的感觉
[00:44.34] 手中的铅笔 在纸上来来回回
[00:51.01] 我用几行字形容你是我的谁
[00:57.44] 秋刀鱼的滋味 猫跟你都想了解
[01:04.19] 初恋的香味 就这样被我们寻回
[01:10.82] 那温暖的阳光 像刚摘的鲜艳草莓
[01:17.54] 你说你舍不得吃掉 这一种感觉
[01:23.66] 雨下整夜 我的爱溢出就像雨水
[01:30.41] 院子落叶 跟我的思念厚厚一叠
[01:37.04] 几句是非 也无法将我的热情冷却
[01:46.75] 你出现在我诗的每一页
[01:50.13] 雨下整夜 我的爱溢出就像雨水
[01:59.86] 窗台蝴蝶 像诗里纷飞的美丽章节
[02:05.49] 我接着写 把永远爱你写进诗的结尾
[02:12.20] 你是我唯一 想要的了解
[02:18.20] 
[02:46.59] 雨下整夜 我的爱溢出就像雨水
[02:52.28] 院子落叶 跟我的思念厚厚一叠
[02:58.91] 几句是非 也无法将我的热情冷却
[03:06.62] 你出现在我诗的每一页
[03:13.00] 那饱满的稻穗 幸福了这个季节
[03:19.70] 而你的脸颊 像田里熟透的蕃茄
[03:26.39] 你突然对我说 七里香的名字很美
[03:32.06] 我此刻却只想亲吻你 倔强的嘴
[03:39.44] 雨下整夜 我的爱溢出就像雨水
[03:46.13] 院子落叶 跟我的思念厚厚一叠
[03:53.76] 几句是非 也无法将我的热情冷却
[03:59.47] 你出现在我诗的每一页
[04:07.85] 雨下整夜 我的爱溢出就像雨水
[04:13.54] 窗台蝴蝶 像诗里纷飞的美丽章节
[04:20.17] 我接着写 把永远爱你写进诗的结尾
[04:28.00] 你是我唯一 想要的了解`;

        // --- 歌词解析器 ---
        function parseLRC(lrc) {
            const lines = lrc.split('\n');
            const result = [];
            const timeReg = /\[(\d{1,2}):(\d{1,2}(?:\.\d{1,3})?)\]/g;
            
            lines.forEach(line => {
                let match;
                const times = [];
                timeReg.lastIndex = 0;

                while ((match = timeReg.exec(line)) !== null) {
                    const min = parseInt(match[1]);
                    const sec = parseFloat(match[2]);
                    times.push(min * 60 + sec);
                }
                
                const text = line.replace(/\[\d{1,2}:\d{1,2}(?:\.\d{1,3})?\]/g, '').trim();
                
                if (text && times.length > 0) {
                    times.forEach(t => {
                        result.push({ time: t, text: text });
                    });
                }
            });
            return result.sort((a, b) => a.time - b.time);
        }

        const lyrics = parseLRC(lrcData);

        // --- 字幕管理器 (星尘散落模式) ---
        const subtitleManager = {
            currentLineIdx: -1,
            container: null,
            scatterFactor: 60, // 控制散落的范围半径
            
            init() {
                this.container = document.getElementById('subtitle-container');
            },

            setScatter(val) {
                this.scatterFactor = val;
            },

            update(currentTime) {
                if (!this.container) return;

                // 容错处理：如果 currentTime 稍微小于第一句，也尝试匹配
                // 解决某些浏览器 audio 延迟启动问题
                const tolerance = 0.5; // 0.5s 容错

                let activeLineIdx = -1;
                for (let i = 0; i < lyrics.length; i++) {
                    if ((currentTime + tolerance) >= lyrics[i].time) {
                        activeLineIdx = i;
                    } else {
                        break;
                    }
                }

                if (activeLineIdx !== this.currentLineIdx) {
                    this.currentLineIdx = activeLineIdx;
                    this.container.innerHTML = ''; 

                    if (activeLineIdx !== -1) {
                        const text = lyrics[activeLineIdx].text;
                        const chars = text.split('');
                        
                        // 计算中心偏移
                        const centerX = this.container.offsetWidth / 2;
                        const centerY = this.container.offsetHeight / 2;

                        chars.forEach((char, index) => {
                            const span = document.createElement('span');
                            span.innerText = char;
                            span.className = 'lyric-char';
                            
                            // 随机延迟：保留出现顺序 (0.05s 间隔) + 微小随机
                            const baseDelay = index * 0.05;
                            const randomBlur = Math.random() > 0.6 ? '2px' : '0px'; 
                            
                            // 核心修改：完全随机坐标散落
                            const angle = Math.random() * Math.PI * 2;
                            const radius = Math.sqrt(Math.random()) * this.scatterFactor * 2; // 分布
                            
                            // 相对位置
                            const left = centerX + (Math.random() - 0.5) * this.container.offsetWidth * 0.8;
                            const top = centerY + (Math.random() - 0.5) * this.container.offsetHeight * 0.8;

                            span.style.left = `${left}px`;
                            span.style.top = `${top}px`;
                            
                            span.style.animationDelay = `${baseDelay}s, 0s, ${Math.random()*2}s`;
                            span.style.filter = `blur(${randomBlur})`;
                            
                            // 随机旋转初始角度
                            const rot = (Math.random() - 0.5) * 30;
                            span.style.transform = `rotate(${rot}deg)`;

                            this.container.appendChild(span);
                        });
                    }
                }
            }
        };

        // --- High Quality Audio Engine (Web Audio API) ---
        const audio = {
            ctx: null,
            bgmStarted: false,
            init() {
                if(!this.ctx) {
                    this.ctx = new (window.AudioContext || window.webkitAudioContext)();
                }
                if(this.ctx.state === 'suspended') {
                    this.ctx.resume();
                }
            },
            
            // 独立的 BGM 启动函数
            startBGM() {
                if (!this.bgmStarted) {
                    const bgmEl = document.getElementById('bgm');
                    bgmEl.volume = 0.25; 
                    
                    const playPromise = bgmEl.play();
                    
                    if (playPromise !== undefined) {
                        playPromise.then(_ => {
                            console.log("Audio playing");
                            this.bgmStarted = true;
                        })
                        .catch(error => {
                            console.log("Audio play blocked: " + error);
                            // Fallback UI or retry logic could go here
                        });
                    }
                }
            },

            playPop() {
                if(!this.ctx) return;
                const t = this.ctx.currentTime;
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                const freqs = [523.25, 587.33, 659.25, 783.99, 880.00];
                osc.frequency.value = freqs[Math.floor(Math.random() * freqs.length)];
                osc.type = 'triangle'; 
                gain.gain.setValueAtTime(0, t);
                gain.gain.linearRampToValueAtTime(0.1, t + 0.05);
                gain.gain.exponentialRampToValueAtTime(0.001, t + 1.0);
                osc.connect(gain); gain.connect(this.ctx.destination);
                osc.start(t); osc.stop(t + 1.0);
            },
            playSparkle() {
                if(!this.ctx) return;
                const t = this.ctx.currentTime;
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.type = 'sine';
                osc.frequency.setValueAtTime(1500 + Math.random()*500, t);
                gain.gain.setValueAtTime(0.02, t);
                gain.gain.exponentialRampToValueAtTime(0.001, t + 0.1);
                osc.connect(gain); gain.connect(this.ctx.destination);
                osc.start(t); osc.stop(t + 0.1);
            },
            playGlow() {
                if(!this.ctx) return;
                const t = this.ctx.currentTime;
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.type = 'triangle'; osc.frequency.setValueAtTime(110, t); 
                gain.gain.setValueAtTime(0, t);
                gain.gain.linearRampToValueAtTime(0.1, t + 0.5);
                gain.gain.linearRampToValueAtTime(0, t + 2.0);
                osc.connect(gain); gain.connect(this.ctx.destination);
                osc.start(t); osc.stop(t + 2.0);
            },
            // Improved Crispier Firework Sound (Optimized)
            playFirework() {
                if(!this.ctx) return;
                const t = this.ctx.currentTime;
                
                // 1. Initial "Pop" (Transient - High Pitch)
                const osc = this.ctx.createOscillator();
                const oscGain = this.ctx.createGain();
                osc.type = 'triangle'; // Crisper than square
                osc.frequency.setValueAtTime(300, t); // Higher starting pitch
                osc.frequency.exponentialRampToValueAtTime(50, t + 0.15);
                oscGain.gain.setValueAtTime(0.3, t);
                oscGain.gain.exponentialRampToValueAtTime(0.001, t + 0.15);
                osc.connect(oscGain); oscGain.connect(this.ctx.destination);
                osc.start(t); osc.stop(t + 0.15);

                // 2. High Frequency Crackle (Richness)
                const bufferSize = this.ctx.sampleRate * 2; 
                const buffer = this.ctx.createBuffer(1, bufferSize, this.ctx.sampleRate);
                const data = buffer.getChannelData(0);
                for (let i = 0; i < bufferSize; i++) { data[i] = Math.random() * 2 - 1; }

                const noise = this.ctx.createBufferSource();
                noise.buffer = buffer;
                
                // Bandpass filter to focus on crisp highs
                const bandpass = this.ctx.createBiquadFilter();
                bandpass.type = 'highpass'; // Only highs
                bandpass.frequency.value = 1500;

                const noiseGain = this.ctx.createGain();
                noiseGain.gain.setValueAtTime(0.4, t);
                noiseGain.gain.exponentialRampToValueAtTime(0.001, t + 1.5); // Longer tail

                // Add some randomness/texture
                const tremolo = this.ctx.createOscillator();
                tremolo.frequency.value = 15; // Fast wobble
                const tremoloGain = this.ctx.createGain();
                tremoloGain.gain.value = 0.2;
                tremolo.connect(tremoloGain.gain);

                noise.connect(bandpass);
                bandpass.connect(noiseGain);
                noiseGain.connect(this.ctx.destination);
                noise.start(t);
            },
            playSuccess() {
                if(!this.ctx) return;
                const t = this.ctx.currentTime;
                [523.25, 659.25, 783.99, 1046.50].forEach((freq, i) => {
                    const osc = this.ctx.createOscillator();
                    const gain = this.ctx.createGain();
                    osc.type = 'triangle'; osc.frequency.value = freq;
                    gain.gain.setValueAtTime(0, t + i*0.1);
                    gain.gain.linearRampToValueAtTime(0.1, t + i*0.1 + 0.1);
                    gain.gain.exponentialRampToValueAtTime(0.001, t + i*0.1 + 2); 
                    osc.connect(gain); gain.connect(this.ctx.destination);
                    osc.start(t + i*0.1); osc.stop(t + i*0.1 + 2);
                });
            }
        };

        // Core Setup
        const canvas = document.getElementById('canvas-bg');
        const ctx = canvas.getContext('2d');
        let width, height;
        let particles = [];
        let mouse = { x: -500, y: -500 };
        let fireworks = [];
        let jarParticles = []; 
        let currentStage = -1; 
        let isTransitioning = false;
        let time = 0;

        function resize() {
            width = canvas.width = window.innerWidth;
            height = canvas.height = window.innerHeight;
            subtitleManager.init();
        }
        window.addEventListener('resize', resize);
        resize();

        window.addEventListener('mousemove', e => { mouse.x = e.clientX; mouse.y = e.clientY; createMouseParticles(); });
        window.addEventListener('touchmove', e => { mouse.x = e.touches[0].clientX; mouse.y = e.touches[0].clientY; createMouseParticles(); });

        // --- Visual Engine ---
        class Star {
            constructor() {
                this.x = Math.random() * width;
                this.y = Math.random() * height;
                this.size = Math.random() * 1.5 + 0.2;
                this.baseAlpha = Math.random() * 0.6 + 0.1;
                this.alpha = this.baseAlpha;
                this.speed = Math.random() * 0.05 + 0.01;
                this.offset = Math.random() * 100;
            }
            update() {
                this.x += Math.sin(time * 0.01 + this.offset) * 0.1;
                this.y += Math.cos(time * 0.01 + this.offset) * 0.1;
                this.alpha = this.baseAlpha + Math.sin(time * 0.05 + this.offset) * 0.15;
                if(this.alpha < 0) this.alpha = 0;
                if(this.x < 0) this.x = width; if(this.x > width) this.x = 0;
                if(this.y < 0) this.y = height; if(this.y > height) this.y = 0;
            }
            draw() {
                ctx.globalCompositeOperation = 'source-over';
                ctx.fillStyle = `rgba(255,255,255,${this.alpha})`;
                ctx.beginPath(); ctx.arc(this.x, this.y, this.size, 0, Math.PI*2); ctx.fill();
            }
        }
        class TrailParticle {
            constructor() {
                this.x = mouse.x; this.y = mouse.y;
                this.size = Math.random() * 2 + 1; 
                this.life = 1; this.decay = 0.02;
                this.angle = Math.random() * Math.PI * 2;
                this.speed = Math.random() * 1.5; 
                this.color = `224, 195, 252`; 
            }
            update() {
                this.x += Math.cos(this.angle)*this.speed; 
                this.y += Math.sin(this.angle)*this.speed;
                this.life -= this.decay;
                this.size *= 0.95; 
            }
            draw() {
                ctx.globalCompositeOperation = 'lighter';
                ctx.fillStyle = `rgba(${this.color}, ${this.life * 0.6})`;
                ctx.shadowBlur = 10;
                ctx.shadowColor = `rgba(${this.color}, ${this.life})`;
                ctx.beginPath(); ctx.arc(this.x, this.y, this.size, 0, Math.PI*2); ctx.fill();
                ctx.shadowBlur = 0;
            }
        }
        
        function getShapePoints(type) {
            const points = [];
            if (type === 'Q') {
                for(let i=0; i<30; i++) {
                    const angle = (i/30) * Math.PI * 2;
                    points.push({x: Math.cos(angle)*0.8, y: Math.sin(angle)*0.8});
                }
                for(let i=0; i<10; i++) { points.push({x: 0.3 + i*0.06, y: 0.3 + i*0.06}); }
            } else if (type === 'Z') {
                for(let i=0; i<15; i++) points.push({x: -0.8 + i*0.11, y: -0.8});
                for(let i=0; i<20; i++) points.push({x: 0.8 - i*0.08, y: -0.8 + i*0.08});
                for(let i=0; i<15; i++) points.push({x: -0.8 + i*0.11, y: 0.8});
            }
            return points;
        }

        class Firework {
            constructor() {
                this.x = Math.random() * width * 0.8 + width*0.1;
                this.y = height;
                this.targetY = Math.random() * height * 0.5 + height * 0.1;
                this.vx = (Math.random()-0.5)*3;
                this.vy = -Math.random()*4 - 10;
                this.exploded = false;
                this.shards = [];
                const rand = Math.random();
                if(rand < 0.3) this.shapeType = 'Q';
                else if(rand < 0.6) this.shapeType = 'Z';
                else this.shapeType = 'normal';
                this.hue = Math.random() * 360;
                this.z = Math.random() * 2 + 0.5; 
            }
            update() {
                if(!this.exploded) {
                    this.x += this.vx; this.y += this.vy; this.vy += 0.15;
                    if(this.vy >= 0 || this.y <= this.targetY) this.explode();
                } else {
                    this.shards.forEach((s,i) => {
                        s.x += s.vx; s.y += s.vy; s.vy += 0.05; 
                        s.life -= 0.015;
                        if (Math.random() > 0.8) s.brightness = 1.5; 
                        else s.brightness = 1;
                        if(s.life <= 0) this.shards.splice(i,1);
                    });
                }
            }
            explode() {
                this.exploded = true;
                audio.playFirework(); 
                const baseSize = this.z; 
                if (this.shapeType !== 'normal') {
                    const points = getShapePoints(this.shapeType);
                    const scale = 80 * this.z; 
                    points.forEach(p => {
                        const jx = (Math.random()-0.5) * 10;
                        const jy = (Math.random()-0.5) * 10;
                        this.shards.push({
                            x: this.x + p.x * scale * 0.1, 
                            y: this.y + p.y * scale * 0.1,
                            vx: p.x * 2 + (Math.random()-0.5)*0.5, 
                            vy: p.y * 2 + (Math.random()-0.5)*0.5,
                            life: 1.2, hue: this.hue,
                            size: (Math.random()*1.2 + 0.5) * baseSize, 
                            brightness: 1
                        });
                    });
                } else {
                    const count = 80 * this.z;
                    for(let i=0; i<count; i++) {
                        const angle = Math.random()*Math.PI*2;
                        const speed = Math.random()*5;
                        this.shards.push({
                            x: this.x, y: this.y,
                            vx: Math.cos(angle)*speed, vy: Math.sin(angle)*speed,
                            life: 1, hue: this.hue + Math.random()*40,
                            size: (Math.random()*1.5 + 0.5) * baseSize, 
                            brightness: 1
                        });
                    }
                }
            }
            draw() {
                ctx.globalCompositeOperation = 'lighter';
                if(!this.exploded) {
                    ctx.fillStyle = `hsl(${this.hue}, 100%, 70%)`;
                    ctx.beginPath(); ctx.arc(this.x, this.y, 1.5*this.z, 0, Math.PI*2); ctx.fill(); 
                    ctx.fillStyle = `rgba(255,255,255,0.1)`;
                    ctx.fillRect(this.x-0.5, this.y, 1*this.z, 10*this.z);
                } else {
                    this.shards.forEach(s => {
                        const alpha = s.life * (Math.random() * 0.5 + 0.5); 
                        ctx.shadowBlur = s.brightness > 1 ? 10 : 0; 
                        ctx.shadowColor = `hsl(${s.hue}, 100%, 80%)`;
                        ctx.fillStyle = `hsla(${s.hue}, 100%, ${70 * s.brightness}%, ${alpha})`;
                        ctx.beginPath(); ctx.arc(s.x, s.y, s.size, 0, Math.PI*2); ctx.fill();
                        ctx.shadowBlur = 0;
                    });
                }
                ctx.globalCompositeOperation = 'source-over';
            }
        }

        const stars = Array(300).fill().map(() => new Star());
        function createMouseParticles() { if(Math.random()>0.5) particles.push(new TrailParticle()); }

        let qzzParticles = [];
        class QzzParticle {
            constructor(x, y, targetX, targetY) {
                this.x = x; this.y = y; this.tx = targetX; this.ty = targetY;
                this.cx = (x + targetX) / 2 + (Math.random() - 0.5) * 100;
                this.cy = (y + targetY) / 2 + (Math.random() - 0.5) * 100;
                this.t = 0; this.speed = Math.random() * 0.02 + 0.01;
                this.arrived = false; this.size = Math.random() * 2 + 1;
            }
            update() {
                if(this.arrived) return;
                this.t += this.speed;
                if(this.t >= 1) { this.t = 1; this.arrived = true; }
                const invT = 1 - this.t;
                this.x = invT * invT * this.x + 2 * invT * this.t * this.cx + this.t * this.t * this.tx;
                this.y = invT * invT * this.y + 2 * invT * this.t * this.cy + this.t * this.t * this.ty;
            }
            draw() {
                if(this.arrived) return; 
                ctx.globalCompositeOperation = 'lighter';
                ctx.fillStyle = `rgba(255, 215, 0, ${1 - this.t + 0.2})`;
                ctx.shadowBlur = 10; ctx.shadowColor = 'gold';
                ctx.beginPath(); ctx.arc(this.x, this.y, this.size, 0, Math.PI*2); ctx.fill();
                ctx.shadowBlur = 0;
            }
        }

        class JarParticle {
            constructor(startX, startY, targetX, targetY, color) {
                this.x = startX; this.y = startY;
                this.cx = (startX + targetX) / 2 + (Math.random() - 0.5) * 50;
                this.cy = Math.min(startY, targetY) - Math.random() * 200; 
                this.tx = targetX; this.ty = targetY;
                this.t = 0; this.speed = Math.random() * 0.015 + 0.01;
                this.color = color; this.inJar = false;
                this.size = Math.random() * 2 + 1.5;
                this.wSpeed = Math.random() * 0.01 + 0.005;
                this.wAngle = Math.random() * Math.PI * 2;
                this.centerX = targetX; this.centerY = targetY;
            }
            update() {
                if (!this.inJar) {
                    this.t += this.speed;
                    if (this.t >= 1) {
                        this.t = 1; this.inJar = true;
                        this.x = this.tx; this.y = this.ty;
                        if(Math.random() > 0.8) audio.playSparkle();
                    } else {
                        const invT = 1 - this.t;
                        this.x = invT * invT * this.x + 2 * invT * this.t * this.cx + this.t * this.t * this.tx;
                        this.y = invT * invT * this.y + 2 * invT * this.t * this.cy + this.t * this.t * this.ty;
                    }
                } else {
                    this.wAngle += (Math.random() - 0.5) * 0.2;
                    this.x += Math.cos(this.wAngle) * 0.5;
                    this.y += Math.sin(this.wAngle) * 0.5;
                    const dx = this.x - this.centerX;
                    const dy = this.y - this.centerY;
                    if(Math.abs(dx) > 60) this.x -= dx*0.05;
                    if(Math.abs(dy) > 80) this.y -= dy*0.05;
                }
            }
            draw() {
                ctx.globalCompositeOperation = 'lighter';
                ctx.fillStyle = this.color;
                ctx.shadowBlur = 8; ctx.shadowColor = this.color;
                ctx.beginPath(); ctx.arc(this.x, this.y, this.size, 0, Math.PI*2); ctx.fill();
                ctx.shadowBlur = 0;
            }
        }

        function drawJarPath(ctx) {
            const isMobile = width < 768;
            const jarW = isMobile ? 120 : 160;
            const jarH = isMobile ? 160 : 200;
            const jarX = width / 2; 
            const bottomMargin = height * (isMobile ? 0.15 : 0.10);
            const jarBottomY = height - bottomMargin;
            const jarTopY = jarBottomY - jarH;
            const left = jarX - jarW / 2;
            const right = jarX + jarW / 2;
            ctx.beginPath();
            ctx.moveTo(left, jarTopY);
            ctx.lineTo(right, jarTopY);
            ctx.lineTo(right, jarBottomY - 30); 
            ctx.quadraticCurveTo(right, jarBottomY, right - 30, jarBottomY);
            ctx.lineTo(left + 30, jarBottomY);
            ctx.quadraticCurveTo(left, jarBottomY, left, jarBottomY - 30);
            ctx.lineTo(left, jarTopY);
            ctx.closePath();
        }

        function loop() {
            time++;
            ctx.globalCompositeOperation = 'source-over'; 
            ctx.fillStyle = 'rgba(5, 5, 16, 0.25)'; 
            ctx.fillRect(0, 0, width, height);

            stars.forEach(s => { s.update(); s.draw(); });
            particles.forEach((p,i) => {
                p.update(); p.draw();
                if(p.life<=0) particles.splice(i,1);
            });
            if(currentStage === -1 && qzzParticles.length > 0) {
                qzzParticles.forEach(p => { p.update(); p.draw(); });
            }
            if(currentStage === 1 && jarParticles.length > 0) {
                jarParticles.forEach(p => { p.update(); if(!p.inJar) p.draw(); });
                ctx.save();
                drawJarPath(ctx);
                ctx.clip(); 
                jarParticles.forEach(p => { if(p.inJar) p.draw(); });
                ctx.restore(); 
            }
            if(currentStage === 10) {
                if(Math.random()<0.08) fireworks.push(new Firework()); 
                fireworks.forEach((f,i) => {
                    f.update(); f.draw();
                    if(f.exploded && f.shards.length===0) fireworks.splice(i,1);
                });
            }
            if (audio.bgmStarted) {
                const bgm = document.getElementById('bgm');
                //console.log(bgm.currentTime); // Debug
                subtitleManager.update(bgm.currentTime);
            }
            requestAnimationFrame(loop);
        }
        
        subtitleManager.init();
        loop();

        // 统一的开始游戏入口
        function startGameSequence() {
             audio.init();
             audio.startBGM(); // 必须在用户点击事件中调用
             game.nextStage();
        }

        const game = {
            transition(curr, next) {
                if(isTransitioning) return;
                isTransitioning = true;
                const c = document.getElementById(curr === -1 ? 'stage-pre' : `stage-${curr}`);
                const n = document.getElementById(`stage-${next}`);
                audio.playGlow(); 
                if(c) {
                    c.classList.add('fade-exit-active');
                    setTimeout(() => c.classList.add('hidden'), 800);
                }
                setTimeout(() => {
                    n.classList.remove('hidden');
                    n.classList.add('fade-enter');
                    void n.offsetWidth;
                    n.classList.add('fade-enter-active');
                    setTimeout(() => {
                        n.classList.remove('fade-enter', 'fade-enter-active');
                        isTransitioning = false;
                    }, 1200);
                    this.initStage(next);
                }, 800);
                currentStage = next;
            },
            nextStage() { this.transition(currentStage, currentStage + 1); },
            initStage(id) {
                if(id===1) this.stage1();
                if(id===2) this.stage2();
                if(id===3) this.stage3();
                if(id===4) this.stage4();
                if(id===5) this.stage5();
                if(id===6) this.stage6();
                if(id===7) this.stage7();
                if(id===8) this.stage8(); 
                if(id===9) this.stage9();
                if(id===10) this.stage10();
            },
            stagePre() {
                const container = document.getElementById('qzz-container');
                const msg = document.getElementById('lucky-msg');
                const chars = ['Q', 'z', 'z'];
                let clicked = 0;
                chars.forEach(char => {
                    const el = document.createElement('div');
                    el.className = 'qzz-char pointer-events-auto'; 
                    el.innerText = char;
                    el.style.left = Math.random() * 60 + 20 + '%';
                    el.style.top = Math.random() * 60 + 20 + '%';
                    el.onclick = (e) => {
                        if(el.style.opacity === '0') return;
                        el.style.opacity = '0'; el.style.pointerEvents = 'none';
                        audio.playPop(); 
                        const rect = el.getBoundingClientRect();
                        const startX = rect.left + rect.width/2;
                        const startY = rect.top + rect.height/2;
                        for(let i=0; i<40; i++) {
                            qzzParticles.push(new QzzParticle(startX + (Math.random()-0.5)*30, startY + (Math.random()-0.5)*30, width/2 + (Math.random()-0.5)*150, height/2 + (Math.random()-0.5)*50));
                        }
                        clicked++;
                        if(clicked === 3) {
                            setTimeout(() => { qzzParticles = []; msg.style.opacity = 1; msg.style.transform = 'scale(1)'; setTimeout(() => game.nextStage(), 3500); }, 1500); 
                        }
                    };
                    container.appendChild(el);
                });
            },
            stage1() {
                const items = [{ t:'t', v:'🍬', c:'#FF69B4' }, { t:'t', v:'🍰', c:'#FFFACD' }, { t:'t', v:'👠', c:'#00FFFF' }, { t:'t', v:'🌅', c:'#FF4500' }, { t:'t', v:'🌷', c:'#FF1493' }, { t:'t', v:'🌙', c:'#FFD700' }, { t:'i', v:'fa-cookie-bite', c:'#D2691E' }, { t:'t', v:'🌸', c:'#FFB7C5' }, { t:'i', v:'fa-cat', c:'#E0C3FC' }, { t:'t', v:'♋', c:'#6495ED' }, { t:'t', v:'♏', c:'#DC143C' }];
                let count = 0;
                const total = items.length;
                document.getElementById('stage1-text').innerText = `存入罐子里的甜蜜 (0/${total})`;
                items.forEach((item, i) => {
                    const el = document.createElement('div');
                    el.className = 'mem-icon absolute pointer-events-auto'; 
                    const randX = Math.random() * 80 + 10; 
                    const randY = Math.random() * 50 + 15; 
                    el.style.left = randX + '%'; el.style.top = randY + '%'; 
                    const scale = Math.random() * 0.4 + 0.8;
                    const rotation = Math.random() * 30 - 15;
                    el.style.transform = `scale(${scale}) rotate(${rotation}deg)`;
                    if(item.t === 'i') el.innerHTML = `<i class="fas ${item.v}" style="color:${item.c}"></i>`;
                    else el.innerHTML = `<span style="font-size:2rem;color:${item.c}">${item.v}</span>`;
                    let floatTime = Math.random() * 100;
                    const floatSpeed = 0.02 + Math.random() * 0.02;
                    const floatRange = 10 + Math.random() * 10;
                    function floatLoop() {
                        if(el.done) return;
                        floatTime += floatSpeed;
                        const offsetX = Math.sin(floatTime) * floatRange * 0.5;
                        const offsetY = Math.cos(floatTime * 0.8) * floatRange;
                        el.style.transform = `scale(${scale}) rotate(${rotation}deg) translate(${offsetX}px, ${offsetY}px)`;
                        requestAnimationFrame(floatLoop);
                    }
                    floatLoop();
                    el.onclick = function() {
                        if(this.done) return; this.done = true;
                        audio.playPop(); 
                        const isMobile = width < 768;
                        const jarH = isMobile ? 160 : 200;
                        const bottomMargin = height * (isMobile ? 0.15 : 0.10);
                        const jarCenterY = height - bottomMargin - (jarH/2);
                        const jarCenterX = width / 2;
                        this.style.transition = 'all 1s cubic-bezier(0.5, 0, 0.5, 1)';
                        this.style.left = (jarCenterX - 25) + 'px'; 
                        this.style.top = (jarCenterY - 25) + 'px'; 
                        this.style.opacity = 0;
                        this.style.transform = `scale(0.2) rotate(${rotation + 720}deg)`; 
                        const rect = this.getBoundingClientRect();
                        const startX = rect.left + rect.width/2;
                        const startY = rect.top + rect.height/2;
                        for(let k=0; k<7; k++) {
                            jarParticles.push(new JarParticle(startX, startY, jarCenterX + (Math.random()-0.5)*60, jarCenterY + (Math.random()-0.5)*80, item.c));
                        }
                        count++;
                        document.getElementById('stage1-text').innerText = `存入罐子里的甜蜜 (${count}/${total})`;
                        if(count===total) setTimeout(() => { audio.playSuccess(); game.nextStage(); }, 4000); 
                    }
                    document.getElementById('stage-1').appendChild(el);
                });
            },
            stage3() {
                const cvs = document.getElementById('constellation-canvas');
                cvs.width = width; cvs.height = height;
                const ctx = cvs.getContext('2d');
                const layout = [{x:0.80, y:0.20}, {x:0.72, y:0.24}, {x:0.65, y:0.27}, {x:0.58, y:0.35}, {x:0.59, y:0.50}, {x:0.45, y:0.52}, {x:0.42, y:0.35}];
                const stars = layout.map(p => ({ x: (p.x * width) + (Math.random()-0.5)*30, y: (p.y * height) + (Math.random()-0.5)*30, active: false }));
                function draw() {
                    if(currentStage !== 3) return;
                    ctx.clearRect(0,0,width,height);
                    ctx.beginPath(); ctx.strokeStyle = 'rgba(255,255,255,0.3)'; ctx.lineWidth = 1;
                    const connections = [[0,1], [1,2], [2,3], [3,4], [4,5], [5,6], [3,6]];
                    connections.forEach(pair => { if(stars[pair[0]].active && stars[pair[1]].active) { ctx.moveTo(stars[pair[0]].x, stars[pair[0]].y); ctx.lineTo(stars[pair[1]].x, stars[pair[1]].y); } });
                    ctx.stroke();
                    stars.forEach((s,i) => {
                        ctx.fillStyle = s.active ? '#fff' : 'rgba(255,255,255,0.3)'; ctx.beginPath(); ctx.arc(s.x, s.y, s.active?6:3, 0, Math.PI*2); ctx.fill();
                        if(s.active) { ctx.shadowBlur = 20; ctx.shadowColor = '#fff'; ctx.beginPath(); ctx.arc(s.x, s.y, 6, 0, Math.PI*2); ctx.fill(); ctx.shadowBlur = 0; }
                    });
                    requestAnimationFrame(draw);
                }
                draw();
                cvs.onclick = e => {
                    const rect = cvs.getBoundingClientRect();
                    const mx = e.clientX - rect.left; const my = e.clientY - rect.top;
                    let allActive = true; let clickedOne = false;
                    stars.forEach(s => { const dist = Math.sqrt((mx-s.x)**2 + (my-s.y)**2); if(dist < 40 && !s.active) { s.active = true; clickedOne = true; } if(!s.active) allActive = false; });
                    if(clickedOne) audio.playPop();
                    if(allActive) { setTimeout(() => { document.getElementById('st3-title').style.opacity = 0; cvs.style.transition = 'opacity 1s'; cvs.style.opacity = 0; audio.playSuccess(); setTimeout(() => game.nextStage(), 1000); }, 500); }
                }
            },
            stage4() {
                const btn = document.getElementById('resist-btn'); const core = document.getElementById('core-glow');
                let pressure = 0; let interval;
                const down = () => { audio.playGlow(); interval = setInterval(() => { pressure = Math.min(pressure+1.5, 100); core.style.opacity = pressure/100; core.style.transform = `scale(${0.2 + pressure/120})`; if(pressure >= 100) { clearInterval(interval); setTimeout(() => game.nextStage(), 1000); } }, 50); }
                const up = () => clearInterval(interval);
                btn.onmousedown = btn.ontouchstart = down; btn.onmouseup = btn.onmouseleave = btn.ontouchend = up;
            },
            stage5() {
                const target = document.getElementById('heart-target'); const beat = document.getElementById('heart-beat'); const icon = document.getElementById('heart-icon');
                let hits = 0; let isGlowPhase = false; let start = Date.now();
                function anim() {
                    if(currentStage!==5) return;
                    const p = (Date.now() - start) % 2500 / 2500;
                    target.style.transform = `scale(${p * 1.5})`; target.style.opacity = 1 - p;
                    if(p > 0.8 || p < 0.15) { icon.classList.add('heart-active'); isGlowPhase = true; } else { icon.classList.remove('heart-active'); isGlowPhase = false; }
                    requestAnimationFrame(anim);
                }
                anim();
                beat.onclick = () => { if(isGlowPhase) { hits++; audio.playPop(); beat.style.boxShadow = `0 0 80px rgba(255, 50, 80, 0.8)`; setTimeout(() => beat.style.boxShadow = `0 0 50px rgba(138,28,41,0.5)`, 300); if(hits===5) { beat.innerHTML = '<i class="fas fa-check text-white text-3xl"></i>'; setTimeout(() => game.nextStage(), 1000); } } }
            },
            stage6() {
                const sc = document.getElementById('scratch-canvas'); const ctx = sc.getContext('2d');
                const container = sc.parentElement; sc.width = container.offsetWidth; sc.height = container.offsetHeight;
                ctx.fillStyle = '#050510'; ctx.fillRect(0,0,sc.width, sc.height);
                ctx.fillStyle = 'rgba(255,255,255,0.4)'; ctx.font = "italic 300 20px 'Noto Serif TC'"; ctx.textAlign = "center"; ctx.fillText("Rub to reveal", sc.width/2, sc.height/2);
                let completed = false; let pixels = 0; let isDown = false;
                const scratch = (x, y) => { if(completed) return; ctx.globalCompositeOperation = 'destination-out'; ctx.beginPath(); ctx.arc(x, y, 30, 0, Math.PI*2); ctx.fill(); pixels++; if(pixels > 150 && !completed) { completed = true; audio.playSuccess(); sc.style.transition = 'opacity 1.5s ease'; sc.style.opacity = 0; setTimeout(() => game.nextStage(), 3000); } };
                const down = () => isDown = true; const up = () => isDown = false;
                const move = (e) => { if(!isDown) return; e.preventDefault(); const r = sc.getBoundingClientRect(); const cx = e.touches ? e.touches[0].clientX : e.clientX; const cy = e.touches ? e.touches[0].clientY : e.clientY; scratch(cx - r.left, cy - r.top); };
                sc.onmousedown = sc.ontouchstart = down; window.onmouseup = window.ontouchend = up; sc.onmousemove = sc.ontouchmove = move;
            },
            stage7() {
                const hCvs = document.getElementById('heat-canvas'); const ctx = hCvs.getContext('2d');
                ctx.fillStyle = 'rgba(200, 240, 255, 0.9)'; ctx.fillRect(0,0,320,320);
                let isDrawing = false; let melted = 0;
                function melt(x, y) { ctx.globalCompositeOperation = 'destination-out'; ctx.beginPath(); ctx.arc(x, y, 20, 0, Math.PI*2); ctx.fill(); melted++; if(melted > 150) { hCvs.style.opacity = 0; hCvs.style.transition = 'opacity 1s'; document.getElementById('shield-reveal').style.opacity = 1; audio.playSuccess(); setTimeout(() => game.nextStage(), 2000); } }
                hCvs.onmousedown = () => isDrawing = true; window.onmouseup = () => isDrawing = false;
                hCvs.onmousemove = e => { if(!isDrawing) return; const r = hCvs.getBoundingClientRect(); melt(e.clientX - r.left, e.clientY - r.top); }
                hCvs.ontouchstart = (e) => { isDrawing = true; e.preventDefault(); }
                window.ontouchend = () => isDrawing = false;
                hCvs.ontouchmove = (e) => { if(!isDrawing) return; const r = hCvs.getBoundingClientRect(); melt(e.touches[0].clientX - r.left, e.touches[0].clientY - r.top); }
            },
            stage8() {
                const knob = document.getElementById('radio-knob'); const display = document.getElementById('freq-val');
                const msg = document.getElementById('freq-msg'); const volSlider = document.getElementById('vol-slider');
                const scatterSlider = document.getElementById('scatter-slider'); const replayBtn = document.getElementById('replay-btn');
                const knobVisCanvas = document.getElementById('knob-visualizer');
                const vCtx = knobVisCanvas.getContext('2d');
                
                let isDragging = false; let currentFreq = 40.0; const targetFreq = 52.7;
                let tuningFactor = 0; // 0 to 1
                
                // Knob Visualizer Loop
                function drawKnobVis() {
                    if (currentStage !== 8) return;
                    vCtx.clearRect(0,0,220,220);
                    const cx = 110, cy = 110, radius = 90;
                    
                    // Reference Ring (Ghost)
                    vCtx.beginPath();
                    vCtx.strokeStyle = 'rgba(255, 215, 0, 0.2)';
                    vCtx.lineWidth = 2;
                    vCtx.arc(cx, cy, radius, 0, Math.PI * 2);
                    vCtx.stroke();
                    
                    // Dynamic Waveform
                    vCtx.beginPath();
                    // Color shifts from noisy blue to golden
                    const r = 0 + (255 * tuningFactor);
                    const g = 243 + (215 - 243) * tuningFactor;
                    const b = 255 + (0 - 255) * tuningFactor;
                    vCtx.strokeStyle = `rgba(${r}, ${g}, ${b}, 0.8)`;
                    vCtx.lineWidth = 3;
                    
                    // Generate wave points
                    for(let i = 0; i <= 360; i+=5) {
                        const angle = i * Math.PI / 180;
                        // Noise factor is inverse of tuning factor
                        const noise = (1 - tuningFactor) * 20 * (Math.random() - 0.5);
                        // Sine wave stabilization
                        const wave = Math.sin(angle * 8 + time * 0.1) * 5 * tuningFactor; 
                        
                        const rDynamic = radius + noise + wave;
                        const x = cx + Math.cos(angle) * rDynamic;
                        const y = cy + Math.sin(angle) * rDynamic;
                        
                        if(i===0) vCtx.moveTo(x, y);
                        else vCtx.lineTo(x, y);
                    }
                    vCtx.closePath();
                    vCtx.stroke();
                    
                    // Glow
                    if(tuningFactor > 0.9) {
                        vCtx.shadowBlur = 20;
                        vCtx.shadowColor = 'gold';
                        vCtx.stroke();
                        vCtx.shadowBlur = 0;
                    }

                    requestAnimationFrame(drawKnobVis);
                }
                drawKnobVis(); // Start Vis Loop

                const updateKnob = (e) => {
                    const rect = knob.getBoundingClientRect();
                    const centerX = rect.left + rect.width / 2; const centerY = rect.top + rect.height / 2;
                    const clientX = e.touches ? e.touches[0].clientX : e.clientX; const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                    const angle = Math.atan2(clientY - centerY, clientX - centerX) * (180 / Math.PI);
                    const rot = angle + 90; 
                    knob.style.transform = `rotate(${rot}deg)`;
                    let normalized = (rot + 180) % 360; if(normalized < 0) normalized += 360;
                    currentFreq = 40 + (normalized / 360) * 20;
                    display.innerText = currentFreq.toFixed(1);
                    
                    // Calc tuning factor
                    const diff = Math.abs(currentFreq - targetFreq);
                    // Map diff (approx 0 to 20) to 0-1 factor. Closer = higher.
                    // Let's say within 5 units we start seeing structure
                    tuningFactor = Math.max(0, 1 - (diff / 5));
                    
                    if (diff < 0.3) {
                        display.style.color = '#e6c288'; display.style.textShadow = '0 0 20px #ffd700'; msg.style.opacity = 1;
                        audio.playSuccess(); setTimeout(() => game.nextStage(), 1500);
                        tuningFactor = 1; // Lock it visually
                    } else { 
                        display.style.color = '#e6c288'; display.style.textShadow = '0 0 10px rgba(255, 215, 0, 0.6)'; 
                    }
                };
                knob.onmousedown = knob.ontouchstart = () => isDragging = true;
                window.onmouseup = window.ontouchend = () => isDragging = false;
                window.onmousemove = window.ontouchmove = (e) => { if(isDragging) updateKnob(e); };
                volSlider.oninput = (e) => { const bgm = document.getElementById('bgm'); if(bgm) bgm.volume = parseFloat(e.target.value); };
                scatterSlider.oninput = (e) => { subtitleManager.setScatter(parseInt(e.target.value)); };
                replayBtn.onclick = () => { const bgm = document.getElementById('bgm'); if(bgm) { bgm.currentTime = 0; bgm.play(); } subtitleManager.currentLineIdx = -1; subtitleManager.container.innerHTML = ''; };
            },
            stage9() {
                const area = document.getElementById('puzzle-area');
                const src = document.getElementById('puzzle-pieces');
                // CLEANUP: Reset containers to fix "skipped" bug or re-entry issues
                area.innerHTML = '';
                src.innerHTML = '';
                
                const IMG = "微信图片_20251104183046_51_782.jpg";
                const FALLBACK = "https://images.unsplash.com/photo-1534447677768-be436bb09401?ixlib=rb-1.2.1&auto=format&fit=crop&w=600&q=80";
                const bg = `url('${IMG}'), url('${FALLBACK}')`;
                let matches = 0;
                let selectedPiece = null;

                for(let i=0; i<12; i++) {
                    const d = document.createElement('div');
                    d.className = 'puzzle-slot w-24 h-24 border border-dashed border-white/20 bg-white/5 flex items-center justify-center cursor-pointer';
                    d.dataset.index = i;
                    d.onclick = () => {
                        if(selectedPiece && !d.classList.contains('filled')) {
                            const pieceId = parseInt(selectedPiece.dataset.index);
                            if(pieceId === i) {
                                d.style.backgroundImage = bg; d.style.backgroundPosition = selectedPiece.style.backgroundPosition;
                                d.style.backgroundSize = "300% 400%"; d.style.border = "none"; d.classList.add('filled');
                                selectedPiece.style.display = 'none'; selectedPiece = null;
                                audio.playPop(); 
                                matches++;
                                if(matches===12) { audio.playSuccess(); setTimeout(()=>game.nextStage(), 1500); }
                            } else { d.style.borderColor = 'red'; setTimeout(() => d.style.borderColor = 'rgba(255,255,255,0.2)', 300); }
                        }
                    };
                    d.ondragover = e => e.preventDefault();
                    d.ondrop = e => { const id = e.dataTransfer.getData('id'); if(id == i) d.onclick(); }
                    area.appendChild(d);
                }
                const idxs = [...Array(12).keys()].sort(()=>Math.random()-0.5);
                idxs.forEach(i => {
                    const p = document.createElement('div');
                    p.id = 'p-'+i; p.draggable = true; p.dataset.index = i;
                    p.className = 'puzzle-piece w-24 h-24 bg-cover cursor-pointer border border-white/30';
                    p.style.backgroundImage = bg; p.style.backgroundSize = "300% 400%";
                    p.style.backgroundPosition = `${(i%3)*50}% ${(Math.floor(i/3))*33.3}%`;
                    p.onclick = () => {
                        document.querySelectorAll('.puzzle-piece').forEach(el => el.classList.remove('selected'));
                        if(selectedPiece === p) selectedPiece = null; else { p.classList.add('selected'); selectedPiece = p; audio.playSparkle(); }
                    };
                    p.ondragstart = e => { e.dataTransfer.setData('id', i); selectedPiece = p; };
                    src.appendChild(p);
                });
            },
            stage10() {
                setTimeout(() => document.getElementById('final-text').style.opacity = 1, 1000);
                setTimeout(() => document.getElementById('sub-final-text').style.opacity = 1, 3000);
            },
            start() { this.stagePre(); }
        };

        game.start();
        game.stage2 = function() {
            const cvs = document.getElementById('orbit-canvas'); const ctx = cvs.getContext('2d');
            const slider = document.getElementById('orbit-slider');
            let a1=0, a2=Math.PI;
            function loop() {
                if(currentStage!==2) return;
                cvs.width = cvs.offsetWidth; cvs.height = cvs.offsetHeight;
                const w = cvs.width, h = cvs.height; const cx = w/2, cy = h/2;
                ctx.clearRect(0,0,w,h);
                const r1= w * 0.25; const baseR2 = parseInt(slider.value); const r2 = (baseR2 / 300) * w;
                ctx.strokeStyle='rgba(255,255,255,0.1)'; ctx.beginPath(); ctx.arc(cx,cy,r1,0,7); ctx.stroke();
                ctx.strokeStyle='rgba(100,150,255,0.3)'; ctx.beginPath(); ctx.arc(cx,cy,r2,0,7); ctx.stroke();
                a1+=0.02; a2+=0.025;
                ctx.fillStyle='#8a1c29'; ctx.beginPath(); ctx.arc(cx+Math.cos(a1)*r1, cy+Math.sin(a1)*r1, 8,0,7); ctx.fill();
                ctx.fillStyle='#3d5afe'; ctx.beginPath(); ctx.arc(cx+Math.cos(a2)*r2, cy+Math.sin(a2)*r2, 8,0,7); ctx.fill();
                if(Math.abs(r1-r2) < w*0.05) { audio.playSuccess(); setTimeout(()=>game.nextStage(),1000); }
                requestAnimationFrame(loop);
            }
            loop();
        }
    </script>
</body>
</html>